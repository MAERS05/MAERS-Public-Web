# MAERS 前端开发指南

本文档规定了项目的前端开发规范、最佳实践以及注意事项。

---

## 📋 目录 (Table of Contents)

- [1. 模块化规范 (ES6 Modules)](#1-模块化规范-es6-modules)
- [2. 关键渲染路径 (Critical Rendering Path)](#2-关键渲染路径-critical-rendering-path)
- [3. 数据交互 (Data Fetching)](#3-数据交互-data-fetching)
- [4. CSS 架构与规范](#4-css-架构与规范)
- [5. 编码风格 (Coding Style)](#5-编码风格-coding-style)
- [6. 安全规范 (Security)](#6-安全规范-security)
- [7. SVG 图标主题适配 (SVG Icon Adaptation)](#7-svg-图标主题适配-svg-icon-adaptation)

---

## 1. 模块化规范 (ES6 Modules)


本项目已全面迁移至原生 ES6 模块标准。

### 1.1 文件结构与命名
- **后缀**: 所有模块文件**必须**以 `.module.js` 结尾。
- **位置**: 业务逻辑存放在 `custom/<module>/` 目录下。
- **分离**: 严格区分 Admin (管理端) 和 Viewer (访客端) 代码。

### 1.2 引用方式 (Import/Export)
- **显式依赖**: 使用 `import` 语句显式声明所有依赖项。
- **相对路径**: 引用项目内模块使用相对路径。
- **严禁全局**: 严禁定义或依赖 `window.MAERS` 全局对象。业务逻辑必须通过模块参数传递。
    - **豁免 (Exemptions)**: 仅允许使用 `MAERS.Toast`, `MAERS.Theme`, `MAERS.ModuleConfig`, `MAERS.Config` 这四个基础设施服务。

```javascript
/* ✅ 推荐写法 */
import { api } from '../../../data-manage/api-client.module.js';
import { renderCard } from './cms-card-renderer.module.js';

export function init() { ... }
```

### 1.3 HTML 入口
在 HTML 文件中引用且仅引用**一个**主入口模块：

```html
<!-- ✅ 正确 -->
<script type="module" src="custom/cms/main.module.js"></script>
```

---

## 2. 关键渲染路径 (Critical Rendering Path)

为了提供极致的首屏体验和无闪烁的主题切换，项目采用了特殊的加载策略。

### 2.1 Flash Guard (防闪烁脚本)
`shared/flash-guard.js` 是项目中**唯一的**非模块脚本。

- **同步执行**: 必须作为普通脚本 (`<script src="...">`) 加载，**禁止**加 `type="module"` 或 `defer`。
- **位置**: 必须放在 `<head>` 的最顶部（早于所有 CSS）。
- **职责**: 
  1. 注入 `.js-loading` 全屏遮罩样式。
  2. 读取 LocalStorage 并设置初始主题 (`light-mode` class)。
  3. 恢复之前的缩放状态与 Favicon。

### 2.2 资源加载顺序
1. `<script src="custom/config.js">` (全局配置环境)
2. `<script src="shared/flash-guard.js">` (阻塞式防闪烁与主题初始化)
3. `<link rel="stylesheet" ...>` (全局样式表：theme.css, style.css)
4. `<script type="module" ...>` (业务代码：theme.module.js -> 业务入口)

---

## 3. 数据交互 (Data Fetching)

### 3.1 JSON 数据源
所有数据文件存储在 `data/` 目录下，格式为标准 JSON。

### 3.2 异步加载
使用 `fetch` API 异步读取数据。禁止使用同步 XHR 或 `<script src="data.js">` 方式。

```javascript
/* ✅ 推荐写法 */
async function loadData() {
    try {
        const response = await fetch('data/notes-tree.json');
        const data = await response.json();
        render(data);
    } catch (e) {
        console.error('Failed to load data:', e);
    }
}
```

---

## 4. CSS 架构与规范

### 4.1 分层架构
- **Base (cms-base.css)**: 核心布局，网格系统，零样式。
- **Theme (cms-theme-default.css)**: 默认的主题装饰（圆角、阴影、颜色）。
- **Module (literature.css)**: 特定模块的自定义样式。

### 4.2 变量优先
优先使用 `static-style/theme.css` 中定义的 CSS 变量（如 `var(--bg-base)`），以自动适配深色/浅色模式。

### 4.3 避免 !important
除非为了覆盖第三方库样式或处理状态切换（如 `.d-none !important`），否则应避免使用 `!important`。

### 4.4 移动端适配策略 (Mobile Adaptation)

**2026-02-05 更新**: 项目采用**物理隔离 + 极致降级**的适配策略。

*   **目录**: 所有针对小屏幕（Tablet/Mobile）的 Media Queries **严禁**写在主 CSS 文件中，必须统一存放在 `custom/zmobile adaptation/` 目录下。
    *   `mobile-global.css`: 对应 `style.css`
    *   `mobile-cms.css`: 对应 `cms-base.css`
    *   `mobile-music.css`: 对应 `music.css`
    *   `mobile-photos.css`: 对应 `photos-viewer.css`
    *   `mobile-album.css`: 对应 `album-viewer.css`
    *   `mobile-literature.css`: 对应 `literature.css`
*   **加载方式**: 必须在主 CSS 文件的**最顶部**通过 `@import` 引入。
    ```css
    /* ✅ 正确写法 (Top of music.css) */
    @import "../../zmobile adaptation/mobile-music.css";
    ```
*   **权重管理**: 移动端样式必须使用 `body .selector` 提升权重以覆盖 Desktop 样式。

#### 极致性能与无动画 (Performance First)
针对移动端设备，项目实施了**激进的性能优化**：
*   **无过渡 (Zero Transition)**: 必须设置 `transition: none !important`。移动端的主题切换应是瞬间完成的。
*   **无渲染 (No Render)**: 对于不需要显示的视觉装饰（如 `#theme-mask`、星空背景），使用 `display: none` 彻底将其从渲染树中移除，而不仅仅是 `opacity: 0`。
*   **扁平化**: 禁用 `backdrop-filter`、`box-shadow` 等昂贵的 GPU 属性。

---

## 5. 编码风格 (Coding Style)

- **事件驱动**: 避免使用 `setInterval` 轮询状态。使用简单的事件发布/订阅 (`on/emit`) 模式来驱动 UI 更新。
- **异步编程**: 优先使用 `async/await`，避免回调地狱。
- **DOM 操作**: 缓存 DOM 查询结果，避免频繁的 `document.querySelector`。
- **注释**: 复杂逻辑必须添加注释，说明"为什么"这么做。

---

## 6. 安全规范 (Security)

### 6.1 XSS 防护 (Cross-Site Scripting)
前端渲染用户生成的内容（如搜索结果、文章标题、文件列表）时，必须严格进行 HTML 转义。

*   **禁止**: 直接使用 `innerHTML` 拼接未处理的字符串。
*   **推荐**: 使用 `textContent` 或 `innerText`。
*   **必须**: 如果必须使用 `innerHTML`（如为了高亮关键词），**必须**先使用 `Utils.escapeHtml()` 处理所有动态数据。

```javascript
import { Utils } from '../shared/utils.module.js';

// ❌ 危险！不要这样做
el.innerHTML = `<span>${userTitle}</span>`;

// ✅ 安全
el.innerHTML = `<span>${Utils.escapeHtml(userTitle)}</span>`;
```

---

## 7. SVG 图标主题适配 (SVG Icon Adaptation)

针对项目中使用的极简单色 SVG 图标（如纯黑或深灰），必须确保其在昼夜模式下具备良好的能见度。

### 7.1 核心策略：CSS Inversion
禁止在 SVG 文件内部硬编码多套颜色。统一使用 CSS `filter` 滤镜进行动态反转。

| 目标效果 | CSS 属性 | 适用场景 |
| :--- | :--- | :--- |
| **纯白 (White)** | `filter: invert(1)` | 核心导航图标、主标题图标（针对纯黑 SVG） |
| **柔灰色 (Soft Gray)** | `filter: invert(0.6)` | 次要列表图标、分类标签（针对深灰 SVG） |

### 7.2 配置规范
为了实现高精准度且不误伤其他资源，必须使用**属性选择器**匹配文件名。

#### 示例代码 (CSS)：
```css
/* 1. 默认状态 (深色模式): 反转颜色 */
.container img[src*="icon-name"] {
    filter: invert(1);
    transition: filter 0.3s ease;
}

/* 2. 浅色模式状态: 还原原始色 */
html.light-mode .container img[src*="icon-name"] {
    filter: none; /* 或 invert(0) */
}
```

### 7.3 注意事项
1.  **分布式适配**: 一个图标若出现在多个页面（如首页卡片和后台模块），需要在各自对应的 CSS（如 `index.css` 和 `admin-portal.css`）中分别写入适配规则。
2.  **避免全局**: 严禁直接对所有 `img` 应用反转。必须限制在具体的容器（如 `.card-icon` 或 `.header-title`）内，并匹配文件名字符串。
3.  **保持纯粹**: 除非视觉上极端不清晰，否则应优先仅使用 `invert()`，避免叠加热度更高的 `brightness()` 或 `contrast()`，以维护瑞士设计的纯粹感。
