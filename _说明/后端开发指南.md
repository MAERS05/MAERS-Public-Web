# MAERS åç«¯å¼€å‘æŒ‡å— (Python)

æœ¬æ–‡æ¡£æ·±å…¥è§£æ MAERS çš„åç«¯æ¶æ„ â€”â€” å³ä½äº `_studio/` ç›®å½•ä¸‹çš„æ ¸å¿ƒå¼•æ“ã€‚

**å®šä½**: æœ¬åç«¯ä»…åœ¨**ç®¡ç†æ¨¡å¼ (Admin Mode)** ä¸‹è¿è¡Œï¼Œè´Ÿè´£ä¸ºå‰ç«¯ç¼–è¾‘å™¨æä¾›æ–‡ä»¶æ“ä½œã€æ•°æ®åº“è¯»å†™å’Œå›¾åƒå¤„ç†èƒ½åŠ›ã€‚

---

## ğŸ“‹ ç›®å½• (Table of Contents)

- [1. æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
- [2. ç›®å½•ç»“æ„ (`_studio/`)](#2-ç›®å½•ç»“æ„-_studio)
- [3. æ ¸å¿ƒæœåŠ¡ (Services)](#3-æ ¸å¿ƒæœåŠ¡-services)
- [4. API è·¯ç”±è§„èŒƒ](#4-api-è·¯ç”±è§„èŒƒ)
- [5. æ•°æ®æµå‘](#5-æ•°æ®æµå‘)

---

## 1. æ¶æ„æ¦‚è§ˆ

MAERS åç«¯åŸºäº **Flask** å¾®æ¡†æ¶æ„å»ºï¼Œéµå¾ªç®€æ´çš„åˆ†å±‚æ¶æ„ï¼š
1.  **Server Layer**: `server.py` - åº”ç”¨å…¥å£ä¸é…ç½®ã€‚
2.  **Route Layer**: `routes.py` - å¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒã€‚
3.  **Service Layer**: `services/` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè¿™æ˜¯æœ€åšçš„ä¸€å±‚ï¼‰ã€‚
4.  **Data Layer**: SQLite (`data/cms.db`, `data/gallery.db`) + File System (`data/*.json`).

---


## 2. ç›®å½•ç»“æ„ (`_studio/`)

```
_studio/
â”œâ”€â”€ config.py           # å…¨å±€é…ç½® (ç«¯å£, è·¯å¾„å¸¸æ•°)
â”œâ”€â”€ server.py           # Flask App åˆå§‹åŒ–ä¸å¯åŠ¨å…¥å£
â”œâ”€â”€ routes.py           # API è·¯ç”±æ³¨å†Œ (Controller)
â”œâ”€â”€ services/           # [æ ¸å¿ƒ] ä¸šåŠ¡é€»è¾‘å°è£…
â”‚   â”œâ”€â”€ cms.py            # å†…å®¹ç®¡ç†æœåŠ¡ (Notes, Literature, Record)
â”‚   â”œâ”€â”€ album.py          # ç›¸å†Œåˆ†ç±»ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ photos.py         # å›¾ç‰‡å¤„ç†ä¸ä¸Šä¼ æœåŠ¡
â”‚   â”œâ”€â”€ music.py          # éŸ³ä¹ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ bili.py           # Bç«™ä¿¡æ¯è·å–è¾…åŠ©
â”œâ”€â”€ clean-data.py       # å…¨é‡åƒåœ¾æ•°æ®æ¸…ç†è„šæœ¬ (DB + Files)
â””â”€â”€ *.bat               # å¿«æ·å¯åŠ¨è„šæœ¬ (å¦‚ï¼šå¯åŠ¨ç®¡ç†åå°(server.py).bat, æ¸…ç†åƒåœ¾æ•°æ®(clean-data.py).bat)
```



---

## 3. æ ¸å¿ƒæœåŠ¡ (Services)

### 3.1 CMS Service (`cms.py`)
è´Ÿè´£ Notes, Literature, Record ä¸‰å¤§å†…å®¹æ¨¡å—ã€‚
- **Trigger**: æ¯æ¬¡å†™å…¥æ“ä½œï¼ˆæ·»åŠ /ä¿®æ”¹/ç§»åŠ¨/åˆ é™¤ï¼‰æˆåŠŸåã€‚
- **Action**: è‡ªåŠ¨ä» SQLite è¯»å–æœ€æ–°æ ‘çŠ¶ç»“æ„ï¼Œç”Ÿæˆæ ‡å‡†çš„ JSON æ–‡ä»¶ï¼ˆå¦‚ `data/notes-tree.json`ï¼‰ã€‚
- **Purpose**: è®©å‰ç«¯åœ¨è®¿å®¢æ¨¡å¼ä¸‹é€šè¿‡ `fetch` è¯»å–é™æ€ JSONï¼Œæ— éœ€è¯·æ±‚åç«¯æ•°æ®åº“ã€‚

### 3.2 Album Service (`album.py` & `photos.py`)
è´Ÿè´£ç”»å»Šæ¨¡å—ã€‚
- **Album Management**: `album.py` å¤„ç†åˆ†ç±»ï¼ˆCategoryï¼‰çš„å¢åˆ æ”¹æŸ¥ä¸æ’åºã€‚
- **Image Processing**: `photos.py` å¤„ç†å›¾ç‰‡ä¸Šä¼ è¯·æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆ Origin / Preview (AVIF) / Thumbnail (WebP)ã€‚
- **Data Sync**: æ¯æ¬¡å˜æ›´åï¼Œè‡ªåŠ¨ç”Ÿæˆ `data/album-data.json` æˆ– `data/photos-data.json` ä¾›å‰ç«¯è¯»å–ã€‚

### 3.3 Music Service (`music.py`)
è´Ÿè´£éŸ³ä¹æ¨¡å—ã€‚
- **Data Sync**: æ¯æ¬¡å˜æ›´åï¼Œç”Ÿæˆ `data/music-data.json`ã€‚


---

## 4. API è·¯ç”±è§„èŒƒ

æ‰€æœ‰ API å®šä¹‰åœ¨ `routes.py` ä¸­ï¼Œå‰ç¼€å‡ä¸º `/api`ã€‚

| HTTP Method | Endpoint | å¯¹åº”çš„ Service æ–¹æ³• | æè¿° |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/nodes` | `db.get_all_nodes()` | è·å–æ‰€æœ‰ç¬”è®°èŠ‚ç‚¹ |
| `POST` | `/api/node/save` | `db.save_node()` -> `export.json()` | ä¿å­˜ç¬”è®°å†…å®¹å¹¶è§¦å‘å¯¼å‡º |
| `POST` | `/api/image/upload` | `image.process_upload()` | ä¸Šä¼ å¹¶å¤„ç†å›¾ç‰‡ |
| `POST` | `/api/node/delete` | `db.delete_node()` -> `export.json()` | åˆ é™¤èŠ‚ç‚¹ |
| `POST` | `/api/node/move` | `db.move_node()` -> `export.json()` | æ‹–æ‹½æ’åº/ç§»åŠ¨ |

---

## 5. æ•°æ®æµå‘

### å†™å…¥æµç¨‹ (Write Flow)
1.  **Frontend**: ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"ï¼Œ`api-client.module.js` å‘é€ POST è¯·æ±‚ã€‚
2.  **Routes**: `routes.py` æ¥æ”¶è¯·æ±‚ï¼Œè§£æ JSON å‚æ•°ã€‚
3.  **Services**: 
    -   `db_service` å°† Markdown å†…å®¹å†™å…¥ SQLiteã€‚
    -   `export_service` è¢«è§¦å‘ï¼Œä» DB è¯»å–å…¨é‡æ ‘ç»“æ„ã€‚
    -   `file_service` å°†æ ‘ç»“æ„å†™å…¥ `data/notes-tree.json`ã€‚
4.  **Response**: è¿”å› `{success: true}`ã€‚

### è¯»å–æµç¨‹ (Read Flow - Admin)
-   **Admin**: ç›´æ¥è¯·æ±‚ `/api/nodes` ä» SQLite è¯»å–ï¼ˆä¿è¯å®æ—¶æ€§ï¼‰ã€‚

### è¯»å–æµç¨‹ (Read Flow - Viewer)
-   **Viewer**: è¯·æ±‚é™æ€æ–‡ä»¶ `data/notes-tree.json`ï¼ˆæå¤§æå‡é€Ÿåº¦ï¼Œæ— éœ€ Python å‚ä¸ï¼‰ã€‚
