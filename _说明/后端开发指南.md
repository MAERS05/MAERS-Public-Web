# MAERS 后端开发指南 (Python)

本文档深入解析 MAERS 的后端架构 —— 即位于 `_studio/` 目录下的核心引擎。

**定位**: 本后端仅在**管理模式 (Admin Mode)** 下运行，负责为前端编辑器提供文件操作、数据库读写和图像处理能力。

---

## 📋 目录 (Table of Contents)

- [1. 架构概览](#1-架构概览)
- [2. 目录结构 (`_studio/`)](#2-目录结构-_studio)
- [3. 核心服务 (Services)](#3-核心服务-services)
- [4. API 路由规范](#4-api-路由规范)
- [5. 数据流向](#5-数据流向)

---

## 1. 架构概览

MAERS 后端基于 **Python 原生 http.server** 构建（无 Flask/Django 依赖），遵循简洁的分层架构：
1.  **Server Layer**: `server.py` - 应用入口与配置。
2.  **Route Layer**: `routes.py` - 处理 HTTP 请求，参数校验。
3.  **Service Layer**: `services/` - 核心业务逻辑（这是最厚的一层）。
4.  **Data Layer**: SQLite (`data/cms.db`, `data/gallery.db`) + File System (`data/*.json`).

---


## 2. 目录结构 (`_studio/`)

```
_studio/
├── config.py           # 全局配置 (端口, 路径常数)
├── server.py           # Python HTTP Server 初始化与启动入口
├── routes.py           # API 路由注册 (Controller)
├── services/           # [核心] 业务逻辑封装
│   ├── cms.py            # 内容管理服务 (Notes, Literature, Record) - SQLite 驱动
│   ├── album.py          # 相册分类管理服务
│   ├── photos.py         # 图片处理与上传服务 - SQLite 驱动
│   ├── music.py          # 音乐管理服务
│   └── bili.py           # B站信息获取辅助
├── clean-data.py       # 全量垃圾数据清理脚本 (DB + Files)
├── wipe-data.py        # [DANGER] 全量数据销毁脚本 (Root Access)
└── *.bat               # 快捷启动脚本 (如：启动管理后台(server.py).bat, 清理垃圾数据(clean-data.py).bat)
```



---

## 3. 核心服务 (Services)

### 3.1 CMS Service (`cms.py`)
负责 Notes, Literature, Record 三大内容模块。
- **Trigger**: 每次写入操作（添加/修改/移动/删除）成功后。
- **Action**: 自动从 `cms.db` 数据库读取最新树状结构，生成标准的 JSON 全量快照文件（如 `data/notes-tree.json`）。
- **Purpose**: 让前端在访客模式下通过 `fetch` 读取静态 JSON，无需请求后端数据库。

### 3.2 Album Service (`album.py` & `photos.py`)
负责画廊模块。
- **Album Management**: `album.py` 处理分类（Category）的增删改查与排序。
- **Image Processing**: `photos.py` 处理图片上传请求，自动生成 Origin / Preview (AVIF) / Thumbnail (WebP)。
- **Persistance**: 所有图片元数据即时写入 `gallery.db`。操作后同步 `photos-data.json`。

### 3.3 Music Service (`music.py`)
负责音乐模块。
- **Data Sync**: 每次变更后，生成 `data/music-data.json`。

### 3.4 Maintenance Tools (维护工具链)
系统提供两个独立的维护脚本，用于数据治理：
*   **Cleaner (`clean-data.py`)**: 
    - 智能扫描全站引用（Markdown, HTML, 数据库, 配置），识别所有正在使用的图片资源。
    - 自动清理 `photos/` 目录下的未引用孤儿文件。
    - 自动修复数据库中的“幽灵记录”（文件已物理删除但 DB 仍残留的记录）。
    - *Update*: 支持中文文件名的正确识别。

*   **Wiper (`wipe-data.py`)**: 
    - **出厂重置**: 一键清空所有数据库表、重置自增 ID (`sqlite_sequence`)。
    - **配置清洗**: 重置 `data/*.json` 及相册配置 (`album-config.module.js`)。
    - **物理销毁**: 彻底删除所有用户上传的物理资源。


---

## 4. API 路由规范

所有 API 定义在 `routes.py` 中，前缀均为 `/api` 或直接暴露。

| HTTP Method | Endpoint | 对应的 Service 方法 | 描述 |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/cms/fetch` | `cms.fetch_module_tree()` | 获取模块的文件树 (从 DB) |
| `POST` | `/api/cms/node` | `cms._action_add/update...` | 对节点执行增删改操作 (写 DB) |
| `POST` | `/upload` | `photos.handle_upload()` | 上传并处理图片 |
| `POST` | `/delete` | `photos.handle_delete()` | 删除图片/节点 |
| `POST` | `/reorder` | `photos.handle_reorder()` | 图片排序 |

---

## 5. 数据流向

### 写入流程 (Write Flow)
1.  **Frontend**: 用户点击"保存"，`api-client.module.js` 发送 POST 请求。
2.  **Routes**: `routes.py` 接收请求，解析 JSON 参数。
3.  **Services**: 
    -   `db_service` 将 Markdown 内容写入 SQLite。
    -   `export_service` 被触发，从 DB 读取全量树结构。
    -   `file_service` 将树结构写入 `data/notes-tree.json`。
4.  **Response**: 返回 `{success: true}`。

### 读取流程 (Read Flow - Admin)
-   **Admin**: 直接请求 `/api/nodes` 从 SQLite 读取（保证实时性）。

### 读取流程 (Read Flow - Viewer)
-   **Viewer**: 请求静态文件 `data/notes-tree.json`（极大提升速度，无需 Python 参与）。
---

## 6. 标准化日志系统 (Standardized Logging)

为了确保各服务在协同工作时具备良好的可维护性，所有后端 Service 均强制遵循 **Studio Engine 双语日志规范**。

### 6.1 日志格式
```text
  [ MODULE ] 图标 描述文本 | English Description
```

### 6.2 模块标识符 (Module Tags)
在开发新功能或打印日志时，请确保使用预定义的模块标签：
*   `[ PAGE ]`: 涉及 `routes.py` 的物理文件系统操作（页面增删）。
*   `[ CMS ]`: 涉及笔记、文学、随笔节点的数据库操作。
*   `[ ALBUM ]`: 涉及相册分类与物理目录同步。
*   `[ PHOTOS ]`: 涉及图片上传、哈希校验、去重恢复。
*   `[ MUSIC ]`: 涉及音乐数据同步、音轨管理。
*   `[ BILI ]`: 涉及外部 API 请求过程。

### 6.3 最佳实践
- **即时回显**: 在逻辑开始处（如 `Request start`）和完成后（如 `Sync success`）均需打印日志。
- **详细信息**: 在日志中包含关键参数（如 `Page Name`, `Category ID`），方便在控制台中直观观察数据流向。
- **双语对齐**: 保持 `|` 符号前后的中英描述语义一致，格式整齐。
