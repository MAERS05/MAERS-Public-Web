# MAERS åç«¯å¼€å‘æŒ‡å— (Python)

æœ¬æ–‡æ¡£æ·±å…¥è§£æ MAERS çš„åç«¯æ¶æ„ â€”â€” å³ä½äº `_studio/` ç›®å½•ä¸‹çš„æ ¸å¿ƒå¼•æ“ã€‚

**å®šä½**: æœ¬åç«¯ä»…åœ¨**ç®¡ç†æ¨¡å¼ (Admin Mode)** ä¸‹è¿è¡Œï¼Œè´Ÿè´£ä¸ºå‰ç«¯ç¼–è¾‘å™¨æä¾›æ–‡ä»¶æ“ä½œã€æ•°æ®åº“è¯»å†™å’Œå›¾åƒå¤„ç†èƒ½åŠ›ã€‚

---

## ğŸ“‹ ç›®å½• (Table of Contents)

- [1. æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
- [2. ç›®å½•ç»“æ„ (`_studio/`)](#2-ç›®å½•ç»“æ„-_studio)
- [3. æ ¸å¿ƒæœåŠ¡ (Services)](#3-æ ¸å¿ƒæœåŠ¡-services)
- [4. API è·¯ç”±è§„èŒƒ](#4-api-è·¯ç”±è§„èŒƒ)
- [5. æ•°æ®æµå‘](#5-æ•°æ®æµå‘)

---

## 1. æ¶æ„æ¦‚è§ˆ

MAERS åç«¯åŸºäº **Python åŸç”Ÿ http.server** æ„å»ºï¼ˆæ—  Flask/Django ä¾èµ–ï¼‰ï¼Œéµå¾ªç®€æ´çš„åˆ†å±‚æ¶æ„ï¼š
1.  **Server Layer**: `server.py` - åº”ç”¨å…¥å£ä¸é…ç½®ã€‚
2.  **Route Layer**: `routes.py` - å¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒã€‚
3.  **Service Layer**: `services/` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè¿™æ˜¯æœ€åšçš„ä¸€å±‚ï¼‰ã€‚
4.  **Data Layer**: SQLite (`data/cms.db`, `data/gallery.db`) + File System (`data/*.json`).

---


## 2. ç›®å½•ç»“æ„ (`_studio/`)

```
_studio/
â”œâ”€â”€ config.py           # å…¨å±€é…ç½® (ç«¯å£, è·¯å¾„å¸¸æ•°)
â”œâ”€â”€ server.py           # Python HTTP Server åˆå§‹åŒ–ä¸å¯åŠ¨å…¥å£
â”œâ”€â”€ routes.py           # API è·¯ç”±æ³¨å†Œ (Controller)
â”œâ”€â”€ services/           # [æ ¸å¿ƒ] ä¸šåŠ¡é€»è¾‘å°è£…
â”‚   â”œâ”€â”€ cms.py            # å†…å®¹ç®¡ç†æœåŠ¡ (Notes, Literature, Record) - SQLite é©±åŠ¨
â”‚   â”œâ”€â”€ album.py          # ç›¸å†Œåˆ†ç±»ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ photos.py         # å›¾ç‰‡å¤„ç†ä¸ä¸Šä¼ æœåŠ¡ - SQLite é©±åŠ¨
â”‚   â”œâ”€â”€ music.py          # éŸ³ä¹ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ bili.py           # Bç«™ä¿¡æ¯è·å–è¾…åŠ©
â”œâ”€â”€ clean-data.py       # å…¨é‡åƒåœ¾æ•°æ®æ¸…ç†è„šæœ¬ (DB + Files)
â”œâ”€â”€ wipe-data.py        # [DANGER] å…¨é‡æ•°æ®é”€æ¯è„šæœ¬ (Root Access)
â””â”€â”€ *.bat               # å¿«æ·å¯åŠ¨è„šæœ¬ (å¦‚ï¼šå¯åŠ¨ç®¡ç†åå°(server.py).bat, æ¸…ç†åƒåœ¾æ•°æ®(clean-data.py).bat)
```



---

## 3. æ ¸å¿ƒæœåŠ¡ (Services)

### 3.1 CMS Service (`cms.py`)
è´Ÿè´£ Notes, Literature, Record ä¸‰å¤§å†…å®¹æ¨¡å—ã€‚
- **Trigger**: æ¯æ¬¡å†™å…¥æ“ä½œï¼ˆæ·»åŠ /ä¿®æ”¹/ç§»åŠ¨/åˆ é™¤ï¼‰æˆåŠŸåã€‚
- **Action**: è‡ªåŠ¨ä» `cms.db` æ•°æ®åº“è¯»å–æœ€æ–°æ ‘çŠ¶ç»“æ„ï¼Œç”Ÿæˆæ ‡å‡†çš„ JSON å…¨é‡å¿«ç…§æ–‡ä»¶ï¼ˆå¦‚ `data/notes-tree.json`ï¼‰ã€‚
- **Purpose**: è®©å‰ç«¯åœ¨è®¿å®¢æ¨¡å¼ä¸‹é€šè¿‡ `fetch` è¯»å–é™æ€ JSONï¼Œæ— éœ€è¯·æ±‚åç«¯æ•°æ®åº“ã€‚

### 3.2 Album Service (`album.py` & `photos.py`)
è´Ÿè´£ç”»å»Šæ¨¡å—ã€‚
- **Album Management**: `album.py` å¤„ç†åˆ†ç±»ï¼ˆCategoryï¼‰çš„å¢åˆ æ”¹æŸ¥ä¸æ’åºã€‚
- **Image Processing**: `photos.py` å¤„ç†å›¾ç‰‡ä¸Šä¼ è¯·æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆ Origin / Preview (AVIF) / Thumbnail (WebP)ã€‚
- **Persistance**: æ‰€æœ‰å›¾ç‰‡å…ƒæ•°æ®å³æ—¶å†™å…¥ `gallery.db`ã€‚æ“ä½œååŒæ­¥ `photos-data.json`ã€‚

### 3.3 Music Service (`music.py`)
è´Ÿè´£éŸ³ä¹æ¨¡å—ã€‚
- **Data Sync**: æ¯æ¬¡å˜æ›´åï¼Œç”Ÿæˆ `data/music-data.json`ã€‚

### 3.4 Space Service (`space.py`)
è´Ÿè´£ç©ºé—´æ¨¡å— (The Space)ã€‚
- **Collection Management**: ç®¡ç† `data/space-collections.json`ï¼Œå­˜å‚¨å¤šç»´æ•°æ®é¡¹ã€‚
- **Tree Persistence**: ç®¡ç† `data/space-tree.json`ï¼Œç»§æ‰¿ CMS çš„æ ‘çŠ¶ç»“æ„é€»è¾‘ã€‚
- **Metadata Fetcher**: æä¾› `fetch_url_metadata` å·¥å…·ï¼ŒåŸºäº URL è‡ªåŠ¨æŠ“å–ç½‘ç«™ Title, Description å’Œ Faviconã€‚

### 3.4 Maintenance Tools (ç»´æŠ¤å·¥å…·é“¾)
ç³»ç»Ÿæä¾›ä¸¤ä¸ªç‹¬ç«‹çš„ç»´æŠ¤è„šæœ¬ï¼Œç”¨äºæ•°æ®æ²»ç†ï¼š
*   **Cleaner (`clean-data.py`)**: 
    - æ™ºèƒ½æ‰«æå…¨ç«™å¼•ç”¨ï¼ˆMarkdown, HTML, æ•°æ®åº“, é…ç½®ï¼‰ï¼Œè¯†åˆ«æ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡èµ„æºã€‚
    - è‡ªåŠ¨æ¸…ç† `photos/` ç›®å½•ä¸‹çš„æœªå¼•ç”¨å­¤å„¿æ–‡ä»¶ã€‚
    - è‡ªåŠ¨ä¿®å¤æ•°æ®åº“ä¸­çš„â€œå¹½çµè®°å½•â€ï¼ˆæ–‡ä»¶å·²ç‰©ç†åˆ é™¤ä½† DB ä»æ®‹ç•™çš„è®°å½•ï¼‰ã€‚
    - *Update*: æ”¯æŒä¸­æ–‡æ–‡ä»¶åçš„æ­£ç¡®è¯†åˆ«ã€‚

*   **Wiper (`wipe-data.py`)**: 
    - **å‡ºå‚é‡ç½®**: ä¸€é”®æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“è¡¨ã€é‡ç½®è‡ªå¢ ID (`sqlite_sequence`)ã€‚
    - **é…ç½®æ¸…æ´—**: é‡ç½® `data/*.json`ï¼ˆå« `album-config.json`ï¼‰ã€‚
    - **ç‰©ç†é”€æ¯**: å½»åº•åˆ é™¤æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„ç‰©ç†èµ„æºã€‚


---

## 4. API è·¯ç”±è§„èŒƒ

æ‰€æœ‰ API å®šä¹‰åœ¨ `routes.py` ä¸­ï¼Œå‰ç¼€å‡ä¸º `/api` æˆ–ç›´æ¥æš´éœ²ã€‚

### 4.1 CMS æ ¸å¿ƒ (Content Management)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/cms/fetch` | `cms.fetch_module_tree` | è·å–æŒ‡å®šæ¨¡å— (Notes/Lit/Record) çš„æ–‡ä»¶æ ‘ã€‚ |
| `POST` | `/api/cms/node` | `cms.handle_request` | èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥é€šç”¨æ¥å£ã€‚ |
| `POST` | `/api/cms/update_tags` | `cms.update_node_tags` | **[Granular]** ä»…æ›´æ–°èŠ‚ç‚¹çš„æ ‡ç­¾å­—æ®µã€‚ |
| `GET` | `/api/cms/tag_categories` | `cms.get_tag_categories` | è·å–å…¨å±€æ ‡ç­¾åˆ†ç±»é…ç½®ã€‚ |
| `POST` | `/api/cms/save_tag_categories` | `cms.save_tag_categories` | ä¿å­˜å…¨å±€æ ‡ç­¾åˆ†ç±»é…ç½®ã€‚ |

### 4.2 å›¾åº“ä¸ç›¸å†Œ (Photos & Album)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/upload` | `photos.handle_upload` | ä¸Šä¼ å›¾ç‰‡ (è‡ªåŠ¨ç”Ÿæˆå¤šçº§ç¼©ç•¥å›¾)ã€‚ |
| `POST` | `/delete` | `photos.handle_delete` | åˆ é™¤å›¾ç‰‡ (æ”¯æŒåŒæ­¥ç‰©ç†åˆ é™¤)ã€‚ |
| `POST` | `/reorder` | `photos.handle_reorder` | å›¾ç‰‡æ‹–æ‹½æ’åºã€‚ |
| `POST` | `/api/photos/update_tags` | `photos.update_tags` | **[New]** æ›´æ–°å›¾ç‰‡æ ‡ç­¾ (Adapter Pattern)ã€‚ |
| `POST` | `/api/add_category` | `album.handle_ops` | æ–°å¢ç›¸å†Œåˆ†ç±»ã€‚ |
| `POST` | `/api/delete_category` | `album.handle_ops` | åˆ é™¤ç›¸å†Œåˆ†ç±»ã€‚ |

### 4.3 ç©ºé—´ä¸é›†åˆ (Space & Collections)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/space/save_tree` | `space.save_tree` | ä¿å­˜ Space æ ‘çŠ¶ç»“æ„ (`space-tree.json`)ã€‚ |
| `POST` | `/api/space/update_tags` | `space.update_node_tags` | **[Granular]** ä»…æ›´æ–° Space èŠ‚ç‚¹çš„æ ‡ç­¾ã€‚ |
| `POST` | `/api/space/fetch_meta` | `space.fetch_url_metadata` | çˆ¬å– URL å…ƒæ•°æ® (Title/Icon)ã€‚ |
| `GET` | `/api/space/collections` | `space.load_collections` | è·å–æ‰å¹³åŒ–æ”¶è—é›†æ•°æ®ã€‚ |
| `POST` | `/api/space/add` | `space.add_collection` | æ·»åŠ æ–°æ”¶è—é¡¹ã€‚ |
| `POST` | `/api/space/update` | `space.update_collection` | æ›´æ–°æ”¶è—é¡¹ä¿¡æ¯ã€‚ |
| `POST` | `/api/space/delete` | `space.delete_collection` | åˆ é™¤æ”¶è—é¡¹ã€‚ |
| `POST` | `/api/space/reorder` | `space.reorder_collections` | æ”¶è—é¡¹æ’åºã€‚ |

### 4.4 éŸ³ä¹ (Music)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/music_data` | `cms.load_json` | è·å–éŸ³ä¹åˆ—è¡¨æ•°æ® `music-data.json`ã€‚ |
| `POST` | `/api/save_music` | `music.save_music_data` | **[Batch]** å…¨é‡ä¿å­˜éŸ³ä¹æ•°æ®ã€‚ |
| `POST` | `/api/delete_track` | `music.delete_track` | åˆ é™¤å•æ›²ã€‚ |
| `POST` | `/api/reset_tracks` | `music.reset_tracks` | é‡ç½®/æ¸…ç©ºæ’­æ”¾åˆ—è¡¨ã€‚ |

### 4.5 ç³»ç»Ÿä¸é—¨æˆ· (System & Portal)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/ensure_page` | `routes.dispatch_post` | **[Auto]** è‡ªåŠ¨åˆ›å»ºç‰©ç† HTML é¡µé¢ã€‚ |
| `POST` | `/api/delete_page` | `routes.dispatch_post` | **[Secure]** ç‰©ç†åˆ é™¤ HTML é¡µé¢ã€‚ |
| `POST` | `/api/save_modules` | `cms.save_json` | ä¿å­˜ `modules.json` é…ç½®ã€‚ |
| `POST` | `/api/save_index_cards` | `cms.save_json` | ä¿å­˜ `index-cards.json` é¦–é¡µé…ç½®ã€‚ |
| `GET` | `/api/get_bili_info` | `bili.get_video_info` | Bilibili è§†é¢‘ä¿¡æ¯è·å–ä»£ç†ã€‚ |

---

## 5. æ•°æ®æµå‘

### å†™å…¥æµç¨‹ (Write Flow)
1.  **Frontend**: ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"ï¼Œ`api-client.module.js` å‘é€ POST è¯·æ±‚ã€‚
2.  **Routes**: `routes.py` æ¥æ”¶è¯·æ±‚ï¼Œè§£æ JSON å‚æ•°ã€‚
3.  **Services**: 
    -   `db_service` å°† Markdown å†…å®¹å†™å…¥ SQLiteã€‚
    -   `export_service` è¢«è§¦å‘ï¼Œä» DB è¯»å–å…¨é‡æ ‘ç»“æ„ã€‚
    -   `file_service` å°†æ ‘ç»“æ„å†™å…¥ `data/notes-tree.json`ã€‚
4.  **Response**: è¿”å› `{success: true}`ã€‚

### è¯»å–æµç¨‹ (Read Flow - Admin)
-   **Admin**: ç›´æ¥è¯·æ±‚ `/api/nodes` ä» SQLite è¯»å–ï¼ˆä¿è¯å®æ—¶æ€§ï¼‰ã€‚

### è¯»å–æµç¨‹ (Read Flow - Viewer)
-   **Viewer**: è¯·æ±‚é™æ€æ–‡ä»¶ `data/notes-tree.json`ï¼ˆæå¤§æå‡é€Ÿåº¦ï¼Œæ— éœ€ Python å‚ä¸ï¼‰ã€‚
---

## 6. æ ‡å‡†åŒ–æ—¥å¿—ç³»ç»Ÿ (Standardized Logging)

ä¸ºäº†ç¡®ä¿å„æœåŠ¡åœ¨ååŒå·¥ä½œæ—¶å…·å¤‡è‰¯å¥½çš„å¯ç»´æŠ¤æ€§ï¼Œæ‰€æœ‰åç«¯ Service å‡å¼ºåˆ¶éµå¾ª **Studio Engine åŒè¯­æ—¥å¿—è§„èŒƒ**ã€‚

### 6.1 æ—¥å¿—æ ¼å¼
```text
  [ MODULE ] å›¾æ ‡ æè¿°æ–‡æœ¬ | English Description
```

### 6.2 æ¨¡å—æ ‡è¯†ç¬¦ (Module Tags)
åœ¨å¼€å‘æ–°åŠŸèƒ½æˆ–æ‰“å°æ—¥å¿—æ—¶ï¼Œè¯·ç¡®ä¿ä½¿ç”¨é¢„å®šä¹‰çš„æ¨¡å—æ ‡ç­¾ï¼š
*   `[ PAGE ]`: æ¶‰åŠ `routes.py` çš„ç‰©ç†æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆé¡µé¢å¢åˆ ï¼‰ã€‚
*   `[ CMS ]`: æ¶‰åŠç¬”è®°ã€æ–‡å­¦ã€éšç¬”èŠ‚ç‚¹çš„æ•°æ®åº“æ“ä½œã€‚
*   `[ ALBUM ]`: æ¶‰åŠç›¸å†Œåˆ†ç±»ä¸ç‰©ç†ç›®å½•åŒæ­¥ã€‚
*   `[ PHOTOS ]`: æ¶‰åŠå›¾ç‰‡ä¸Šä¼ ã€å“ˆå¸Œæ ¡éªŒã€å»é‡æ¢å¤ã€‚
*   `[ MUSIC ]`: æ¶‰åŠéŸ³ä¹æ•°æ®åŒæ­¥ã€éŸ³è½¨ç®¡ç†ã€‚
*   `[ BILI ]`: æ¶‰åŠå¤–éƒ¨ API è¯·æ±‚è¿‡ç¨‹ã€‚

### 6.3 æœ€ä½³å®è·µ
- **å³æ—¶å›æ˜¾**: åœ¨é€»è¾‘å¼€å§‹å¤„ï¼ˆå¦‚ `Request start`ï¼‰å’Œå®Œæˆåï¼ˆå¦‚ `Sync success`ï¼‰å‡éœ€æ‰“å°æ—¥å¿—ã€‚
- **è¯¦ç»†ä¿¡æ¯**: åœ¨æ—¥å¿—ä¸­åŒ…å«å…³é”®å‚æ•°ï¼ˆå¦‚ `Page Name`, `Category ID`ï¼‰ï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°ä¸­ç›´è§‚è§‚å¯Ÿæ•°æ®æµå‘ã€‚
- **åŒè¯­å¯¹é½**: ä¿æŒ `|` ç¬¦å·å‰åçš„ä¸­è‹±æè¿°è¯­ä¹‰ä¸€è‡´ï¼Œæ ¼å¼æ•´é½ã€‚
