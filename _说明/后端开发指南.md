# MAERS 后端开发指南 (Python)

本文档深入解析 MAERS 的后端架构 —— 即位于 `_studio/` 目录下的核心引擎。

**定位**: 本后端仅在**管理模式 (Admin Mode)** 下运行，负责为前端编辑器提供文件操作、数据库读写和图像处理能力。

---

## 📋 目录 (Table of Contents)

- [1. 架构概览](#1-架构概览)
- [2. 目录结构 (`_studio/`)](#2-目录结构-_studio)
- [3. 核心服务 (Services)](#3-核心服务-services)
- [4. API 路由规范](#4-api-路由规范)
- [5. 数据流向](#5-数据流向)
- [6. 标准化日志系统](#6-标准化日志系统-standardized-logging)
- [7. 管理操作手册](#7-管理操作手册-management-operations-manual)

---

## 1. 架构概览

MAERS 后端基于 **Python 原生 http.server** 构建（无 Flask/Django 依赖），遵循简洁的分层架构：
1.  **Server Layer**: `server.py` - 应用入口与配置。
2.  **Route Layer**: `routes.py` - 处理 HTTP 请求，参数校验。
3.  **Service Layer**: `services/` - 核心业务逻辑（处理 DB 索引与物理文件同步）。
4.  **Data Layer**: 
    -   **Index**: SQLite (`data/cms.db`, `data/gallery.db`)。
    -   **Content**: Markdown Files (`data/notes/*.md` etc.)。
    -   **Snapshot**: JSON 树状缓存 (`data/*.json`)。

---


## 2. 目录结构 (`_studio/`)

```
_studio/
├── config.py           # 全局配置 (端口, 路径常数)
├── server.py           # Python HTTP Server 初始化与启动入口
├── routes.py           # API 路由注册 (Controller)
├── services/           # [核心] 业务逻辑封装
│   ├── cms.py            # [核心] 内容与标签管理服务 - 混合驱动 (SQL + MD + JSON)
│   ├── album.py          # 相册分类管理服务
│   ├── photos.py         # 图片处理与上传服务 - SQLite 驱动
│   ├── space.py          # 空间模块服务
│   ├── music.py          # 音乐管理服务
│   └── bili.py           # B站信息获取辅助
├── clean-data.py       # 全量垃圾数据清理脚本 (DB + Files)
├── wipe-data.py        # [DANGER] 全量数据销毁脚本 (Root Access)
└── *.bat               # 快捷启动脚本 (如：启动管理后台(server.py).bat, 清理垃圾数据(clean-data.py).bat)
```



---

## 3. 核心服务 (Services)

### 3.1 CMS Service (`cms.py`)
负责 Notes, Literature, Record, Games 四大内容模块。
- **Index Management**: 所有的节点层级、标题、标签均存储在 `cms.db`。正文内容存储为指向磁盘 `.md` 文件的相对路径。
- **File Sync**: 
    -   **Add**: 自动在 `data/<module>/` 创建经过命名的 `.md` 文件。
    -   **Update**: 同步更新 `.md` 文件正文。
    -   **Rename**: 标题变更时，物理文件自动执行重命名，防止路径失效。
    -   **Delete**: 物理删除对应的 `.md` 文件。
- **Tag Management [NEW]**: 
    -   不再存储于数据库。标签分类配置现在存储在 `data/tags/cms-{module}-tag-categories.json` 或 `data/tags/photos-{category}-tag-categories.json`。
    -   API 统一封装为 `get_tag_categories` 和 `save_tag_categories`，支持多模块复用。
    -   **Tag Cleanup**: `cleanup_unused_tags` 支持跨数据源清理（Photos 查询 `gallery.db`，Space 读取 `space-tree.json`，CMS 查询 `cms.db`），仅移除未使用的标签，保留空分类。
- **Static Snapshot**: 每次写入操作后，重新生成 JSON 树状文件（如 `data/notes-tree.json`）。该文件现在仅包含节点元数据，不含正文，因此体积大幅缩小。

### 3.2 Album Service (`album.py` & `photos.py`)
负责画廊模块。
- **Album Management**: `album.py` 处理分类（Category）的增删改查与排序。
- **Image Processing**: `photos.py` 处理图片上传请求，自动生成 Origin / Preview (AVIF) / Thumbnail (WebP)。
- **Persistence**: 所有图片元数据即时写入 `gallery.db`。操作后同步 `photos-data.json`。

### 3.3 Music Service (`music.py`)
负责音乐模块。
- **Data Sync**: 每次变更后，生成 `data/music-data.json`。

### 3.4 Space Service (`space.py`)
负责空间模块 (The Space)。
- **Collection Management**: 管理 `data/space-collections.json`，存储多维数据项。
- **Tree Persistence**: 管理 `data/space-tree.json`，继承 CMS 的树状结构逻辑。
- **Metadata Fetcher**: 提供 `fetch_url_metadata` 工具，基于 URL 自动抓取网站 Title, Description 和 Favicon。

### 3.5 Maintenance Tools (维护工具链)
系统提供两个独立的维护脚本，用于数据治理：
*   **Cleaner (`clean-data.py`)**: 
    - 智能扫描全站引用（Markdown, HTML, 数据库, 配置），识别所有正在使用的图片资源。
    - 自动清理 `photos/` 目录下的未引用孤儿文件。
    - 自动修复数据库中的“幽灵记录”（文件已物理删除但 DB 仍残留的记录）。
    - *Update*: 支持中文文件名的正确识别。

*   **Wiper (`wipe-data.py`)**: 
    - **出厂重置**: 一键清空所有数据库表、重置自增 ID (`sqlite_sequence`)。
    - **配置清洗**: 重置 `data/*.json`（含 `album-config.json` 及 `data/tags/` 下的所有标签配置文件）。
    - **物理销毁**: 彻底删除所有用户上传的物理资源。
    - **结构容错**: 强制重置树状 JSON 为 `{"root": []}`，确保前端初始化不报错。


---

## 4. API 路由规范

所有 API 定义在 `routes.py` 中，前缀均为 `/api` 或直接暴露。

### 4.1 CMS 核心 (Content Management)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/cms/fetch` | `cms.fetch_module_tree` | 获取指定模块 (Notes/Lit/Record) 的文件树。 |
| `POST` | `/api/cms/node` | `cms.handle_request` | 节点增删改查通用接口。 |
| `POST` | `/api/cms/update_tags` | `cms.update_node_tags` | **[Granular]** 仅更新节点的标签字段。 |
| `GET` | `/api/cms/get_categories` | `cms.get_tag_categories` | 获取指定模块的标签分类配置。 |
| `POST` | `/api/cms/save_categories` | `cms.save_tag_categories` | 保存指定模块的标签分类配置。 |
| `POST` | `/api/cms/cleanup_tags` | `cms.cleanup_unused_tags` | **[Manual]** 清理未使用的标签（保留空分类）。支持 Photos/Space/CMS 模块。 |

### 4.2 图库与相册 (Photos & Album)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/upload` | `photos.handle_upload` | 上传图片 (自动生成多级缩略图)。 |
| `POST` | `/delete` | `photos.handle_delete` | 删除图片 (支持同步物理删除)。 |
| `POST` | `/reorder` | `photos.handle_reorder` | 图片拖拽排序。 |
| `POST` | `/api/photos/update_tags` | `photos.update_tags` | **[New]** 更新图片标签 (Adapter Pattern)。 |
| `POST` | `/api/add_category` | `album.handle_ops` | 新增相册分类。 |
| `POST` | `/api/delete_category` | `album.handle_ops` | 删除相册分类。 |

### 4.3 空间与集合 (Space & Collections)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/space/save_tree` | `space.save_tree` | 保存 Space 树状结构 (`space-tree.json`)。 |
| `POST` | `/api/space/update_tags` | `space.update_node_tags` | **[Granular]** 仅更新 Space 节点的标签。 |
| `POST` | `/api/space/fetch_meta` | `space.fetch_url_metadata` | 爬取 URL 元数据 (Title/Icon)。 |
| `GET` | `/api/space/collections` | `space.load_collections` | 获取扁平化收藏集数据。 |
| `POST` | `/api/space/add` | `space.add_collection` | 添加新收藏项。 |
| `POST` | `/api/space/update` | `space.update_collection` | 更新收藏项信息。 |
| `POST` | `/api/space/delete` | `space.delete_collection` | 删除收藏项。 |
| `POST` | `/api/space/reorder` | `space.reorder_collections` | 收藏项排序。 |

### 4.4 音乐 (Music)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/music_data` | `cms.load_json` | 获取音乐列表数据 `music-data.json`。 |
| `POST` | `/api/save_music` | `music.save_music_data` | **[Batch]** 全量保存音乐数据。 |
| `POST` | `/api/delete_track` | `music.delete_track` | 删除单曲。 |
| `POST` | `/api/reset_tracks` | `music.reset_tracks` | 重置/清空播放列表。 |

### 4.5 系统与门户 (System & Portal)
| Method | Endpoint | Internal Handler | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/ensure_page` | `routes.dispatch_post` | **[Auto]** 自动创建物理 HTML 页面。 |
| `POST` | `/api/delete_page` | `routes.dispatch_post` | **[Secure]** 物理删除 HTML 页面。 |
| `POST` | `/api/save_modules` | `cms.save_json` | 保存 `admin-portal.json` 配置。 |
| `POST` | `/api/save_index_cards` | `cms.save_json` | 保存 `index-cards.json` 首页配置。 |
| `GET` | `/api/get_bili_info` | `bili.get_video_info` | Bilibili 视频信息获取代理。 |

---

## 5. 数据流向

### 写入流程 (Write Flow)
1.  **Frontend**: 用户点击"保存"，`api-client.module.js` 发送 POST 请求。
2.  **Routes**: `routes.py` 接收请求，解析 JSON 参数。
3.  **Services**: 
    -   `file_service` 将 Markdown 内容物理写入磁盘 `.md` 文件。
    -   `db_service` 更新 SQLite，存储节点元数据及指向该 `.md` 文件的相对路径。
    -   `export_service` 被触发，从 DB 读取元数据（不含正文）。
    -   `index_service` 将更新后的树结构索引写入 `data/*-tree.json`。
4.  **Response**: 返回 `{success: true}`。

### 读取流程 (Read Flow - Admin)
-   **Admin**: 直接请求 `/api/nodes` 从 SQLite 读取（保证实时性）。

### 读取流程 (Read Flow - Viewer)
- **Viewer**: 请求静态文件 `data/notes-tree.json` 获取目录，随后按需 Fetch 具体的 `.md` 正文文件（极大提升加载速度，降低流量消耗）。
---

## 6. 标准化日志系统 (Standardized Logging)

为了确保各服务在协同工作时具备良好的可维护性，所有后端 Service 均强制遵循 **Studio Engine 双语日志规范**。

### 6.1 日志格式
```text
  [ MODULE ] 图标 描述文本 | English Description
```

### 6.2 模块标识符 (Module Tags)
在开发新功能或打印日志时，请确保使用预定义的模块标签：
*   `[ PAGE ]`: 涉及 `routes.py` 的物理文件系统操作（页面增删）。
*   `[ CMS ]`: 涉及笔记、文学、记录节点的数据库操作。
*   `[ ALBUM ]`: 涉及相册分类与物理目录同步。
*   `[ PHOTOS ]`: 涉及图片上传、哈希校验、去重恢复。
*   `[ MUSIC ]`: 涉及音乐数据同步、音轨管理。
*   `[ BILI ]`: 涉及外部 API 请求过程。

### 6.3 最佳实践
- **即时回显**: 在逻辑开始处（如 `Request start`）和完成后（如 `Sync success`）均需打印日志。
- **详细信息**: 在日志中包含关键参数（如 `Page Name`, `Category ID`），方便在控制台中直观观察数据流向。
- **双语对齐**: 保持 `|` 符号前后的中英描述语义一致，格式整齐。

---

## 7. 管理操作手册 (Management Operations Manual)

本章节面向**网站管理员**，详述如何使用现有系统进行内容与配置管理。

### 7.1 通用管理 (General)
*   **启动服务**: 双击运行根目录下的 `启动管理后台(server.py).bat`。看到 "🚀 服务器已启动" 即表示就绪。
*   **进入后台**: 浏览器访问 `http://localhost:8000/admin-index.html` (PC端) 或 `http://localhost:8000/admin-portal.html` (移动端推荐)。
*   **退出服务**: 直接关闭 CMD 命令行窗口。

### 7.2 CMS 内容管理 (笔记/文学/游戏/记录)
适用于 `notes`, `literature`, `games`, `record` 四大模块。

*   **新建文章**:
    1.  进入对应模块 (如 Literature)。
    2.  点击右下角悬浮球的 `+` 按钮，或顶部导航栏的 `Create Note`。
    3.  输入标题后，系统会自动创建 `data/literature/新标题.md` 并写入数据库索引。
*   **编辑内容**:
    1.  点击卡片进入阅读页，点击右上角 `Edit` 按钮。
    2.  编辑器支持实时预览，`Ctrl+S` 保存。保存时会自动同步更新物理 `.md` 文件。
*   **移动与排序**:
    1.  点击顶部工具栏的 `Sort` 按钮进入排序模式。
    2.  **拖拽移动**: 直接拖拽卡片，可以调整其在当前层级的顺序。
    3.  **层级变更**: 将卡片拖入另一个文件夹卡片上，即可将其移动到该文件夹内。
    4.  **移出文件夹**: 在面包屑导航中，将卡片拖拽至上级目录的面包屑节点上。
*   **标签管理**:
    1.  在列表页点击 `Tags` 打开标签抽屉。
    2.  **新建/重命名分类**: 只有在管理员模式下，抽屉底部会出现 `+ 添加分类` 按钮。点击分类标题旁的 `✎` 可重命名。
    3.  **移动标签**: 选中多个标签后，点击分类标题右侧的 `移动至此` 按钮。
    4.  **清理未使用标签**: 点击抽屉顶部的垃圾桶图标 (🗑️)，系统会扫描当前模块的所有内容，移除未被引用的标签。分类本身会保留（即使变为空分类）。
    5.  *注意*: 所有变更会自动写入 `data/tags/cms-xxx-tag-categories.json` 或 `data/tags/photos-xxx-tag-categories.json`。
*   **新增模块** (如需新增 `blog`):
    1.  在 `data/` 下新建 `blog/` 目录。
    2.  在 `data/admin-portal.json` 中添加入口卡片配置。
    3.  在 `custom/module-config.module.js` 中注册模块信息 (图标、颜色)。

### 7.3 图库与相册 (Photos & Album)
*   **层级结构**: `Category` (分类) -> `Photos` (图片)。
*   **创建分类**: 
    1.  进入 Album 模块 (相册入口)。
    2.  点击顶部 `+ New Category` (如 "2025年")。文件夹将自动在 `photos/images/` 下创建。
*   **上传图片**:
    1.  进入具体的 Category 分类详情页。
    2.  将图片文件拖入浏览器窗口，或点击上传按钮。
    3.  **自动处理**: 后端会自动生成 `WebP` (列表缩略图) 和 `AVIF` (高清预览图)，原图保留用于下载。
*   **设为封面**:
    1.  在单张图片详情页（灯箱模式），点击 `Set as Cover`。
    2.  该图片将作为当前 Category 分类的封面图。

### 7.4 空间管理 (The Space)
Space 模块是一个多维度的收藏夹容器。
*   **添加组**: 点击 `+ Add Group`，输入组名 (如 "常用工具", "设计灵感")。
*   **添加项**: 
    1.  在组内点击 `+`。
    2.  输入 URL。
    3.  系统会自动请求后端 (`space.fetch_url_metadata`) 抓取该网站的 `Title` 和 `Favicon`。

### 7.5 音乐管理 (Music)
*   **导入专辑**:
    1.  进入 Music 模块，选择分类。
    2.  点击 `+ Add Album`。
    3.  **强烈推荐**: 输入 Bilibili `BV号` (如 `BV1xx...`)。
    4.  系统会自动拉取 B站视频的**封面**、**标题**、**分P列表**和**时长信息**。
*   **手动修整**:
    1.  点击专辑进入详情。
    2.  点击 `Edit` 进入编辑模式，可重命名分P或删除不需要的音轨。
    3.  点击 `Save` 写入 `data/music-data.json`。

### 7.6 维护与清理
*   **清理未引用资源**:
    1.  双击运行 `清理垃圾数据(clean-data.py).bat`。
    2.  脚本会扫描全站 Markdown、HTML 和 JSON，找出所有未被引用的图片并**物理删除**。
    3.  *Use Case*: 当你删除了大量文章后，使用此工具释放磁盘空间。
*   **出厂重置**:
    1.  双击运行 `清空所有数据(wipe-data.py).bat`。
    2.  **警告**: 这会删除所有用户上传的图片、文档、音乐和配置，仅保留代码框架。慎用！
