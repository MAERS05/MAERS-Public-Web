# MAERS åç«¯å¼€å‘æŒ‡å— (Python)

æœ¬æ–‡æ¡£æ·±å…¥è§£æ MAERS çš„åç«¯æ¶æ„ â€”â€” å³ä½äº `_studio/` ç›®å½•ä¸‹çš„æ ¸å¿ƒå¼•æ“ã€‚

**å®šä½**: æœ¬åç«¯ä»…åœ¨**ç®¡ç†æ¨¡å¼ (Admin Mode)** ä¸‹è¿è¡Œï¼Œè´Ÿè´£ä¸ºå‰ç«¯ç¼–è¾‘å™¨æä¾›æ–‡ä»¶æ“ä½œã€æ•°æ®åº“è¯»å†™å’Œå›¾åƒå¤„ç†èƒ½åŠ›ã€‚

---

## ğŸ“‹ ç›®å½• (Table of Contents)

- [1. æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
- [2. ç›®å½•ç»“æ„ (`_studio/`)](#2-ç›®å½•ç»“æ„-_studio)
- [3. æ ¸å¿ƒæœåŠ¡ (Services)](#3-æ ¸å¿ƒæœåŠ¡-services)
- [4. API è·¯ç”±è§„èŒƒ](#4-api-è·¯ç”±è§„èŒƒ)
- [5. æ•°æ®æµå‘](#5-æ•°æ®æµå‘)

---

## 1. æ¶æ„æ¦‚è§ˆ

MAERS åç«¯åŸºäº **Python åŸç”Ÿ http.server** æ„å»ºï¼ˆæ—  Flask/Django ä¾èµ–ï¼‰ï¼Œéµå¾ªç®€æ´çš„åˆ†å±‚æ¶æ„ï¼š
1.  **Server Layer**: `server.py` - åº”ç”¨å…¥å£ä¸é…ç½®ã€‚
2.  **Route Layer**: `routes.py` - å¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒã€‚
3.  **Service Layer**: `services/` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè¿™æ˜¯æœ€åšçš„ä¸€å±‚ï¼‰ã€‚
4.  **Data Layer**: SQLite (`data/cms.db`, `data/gallery.db`) + File System (`data/*.json`).

---


## 2. ç›®å½•ç»“æ„ (`_studio/`)

```
_studio/
â”œâ”€â”€ config.py           # å…¨å±€é…ç½® (ç«¯å£, è·¯å¾„å¸¸æ•°)
â”œâ”€â”€ server.py           # Python HTTP Server åˆå§‹åŒ–ä¸å¯åŠ¨å…¥å£
â”œâ”€â”€ routes.py           # API è·¯ç”±æ³¨å†Œ (Controller)
â”œâ”€â”€ services/           # [æ ¸å¿ƒ] ä¸šåŠ¡é€»è¾‘å°è£…
â”‚   â”œâ”€â”€ cms.py            # å†…å®¹ç®¡ç†æœåŠ¡ (Notes, Literature, Record) - SQLite é©±åŠ¨
â”‚   â”œâ”€â”€ album.py          # ç›¸å†Œåˆ†ç±»ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ photos.py         # å›¾ç‰‡å¤„ç†ä¸ä¸Šä¼ æœåŠ¡ - SQLite é©±åŠ¨
â”‚   â”œâ”€â”€ music.py          # éŸ³ä¹ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ bili.py           # Bç«™ä¿¡æ¯è·å–è¾…åŠ©
â”œâ”€â”€ clean-data.py       # å…¨é‡åƒåœ¾æ•°æ®æ¸…ç†è„šæœ¬ (DB + Files)
â”œâ”€â”€ wipe-data.py        # [DANGER] å…¨é‡æ•°æ®é”€æ¯è„šæœ¬ (Root Access)
â””â”€â”€ *.bat               # å¿«æ·å¯åŠ¨è„šæœ¬ (å¦‚ï¼šå¯åŠ¨ç®¡ç†åå°(server.py).bat, æ¸…ç†åƒåœ¾æ•°æ®(clean-data.py).bat)
```



---

## 3. æ ¸å¿ƒæœåŠ¡ (Services)

### 3.1 CMS Service (`cms.py`)
è´Ÿè´£ Notes, Literature, Record ä¸‰å¤§å†…å®¹æ¨¡å—ã€‚
- **Trigger**: æ¯æ¬¡å†™å…¥æ“ä½œï¼ˆæ·»åŠ /ä¿®æ”¹/ç§»åŠ¨/åˆ é™¤ï¼‰æˆåŠŸåã€‚
- **Action**: è‡ªåŠ¨ä» `cms.db` æ•°æ®åº“è¯»å–æœ€æ–°æ ‘çŠ¶ç»“æ„ï¼Œç”Ÿæˆæ ‡å‡†çš„ JSON å…¨é‡å¿«ç…§æ–‡ä»¶ï¼ˆå¦‚ `data/notes-tree.json`ï¼‰ã€‚
- **Purpose**: è®©å‰ç«¯åœ¨è®¿å®¢æ¨¡å¼ä¸‹é€šè¿‡ `fetch` è¯»å–é™æ€ JSONï¼Œæ— éœ€è¯·æ±‚åç«¯æ•°æ®åº“ã€‚

### 3.2 Album Service (`album.py` & `photos.py`)
è´Ÿè´£ç”»å»Šæ¨¡å—ã€‚
- **Album Management**: `album.py` å¤„ç†åˆ†ç±»ï¼ˆCategoryï¼‰çš„å¢åˆ æ”¹æŸ¥ä¸æ’åºã€‚
- **Image Processing**: `photos.py` å¤„ç†å›¾ç‰‡ä¸Šä¼ è¯·æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆ Origin / Preview (AVIF) / Thumbnail (WebP)ã€‚
- **Persistance**: æ‰€æœ‰å›¾ç‰‡å…ƒæ•°æ®å³æ—¶å†™å…¥ `gallery.db`ã€‚æ“ä½œååŒæ­¥ `photos-data.json`ã€‚

### 3.3 Music Service (`music.py`)
è´Ÿè´£éŸ³ä¹æ¨¡å—ã€‚
- **Data Sync**: æ¯æ¬¡å˜æ›´åï¼Œç”Ÿæˆ `data/music-data.json`ã€‚

### 3.4 Maintenance Tools (ç»´æŠ¤å·¥å…·é“¾)
ç³»ç»Ÿæä¾›ä¸¤ä¸ªç‹¬ç«‹çš„ç»´æŠ¤è„šæœ¬ï¼Œç”¨äºæ•°æ®æ²»ç†ï¼š
*   **Cleaner (`clean-data.py`)**: 
    - æ™ºèƒ½æ‰«æå…¨ç«™å¼•ç”¨ï¼ˆMarkdown, HTML, æ•°æ®åº“, é…ç½®ï¼‰ï¼Œè¯†åˆ«æ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„å›¾ç‰‡èµ„æºã€‚
    - è‡ªåŠ¨æ¸…ç† `photos/` ç›®å½•ä¸‹çš„æœªå¼•ç”¨å­¤å„¿æ–‡ä»¶ã€‚
    - è‡ªåŠ¨ä¿®å¤æ•°æ®åº“ä¸­çš„â€œå¹½çµè®°å½•â€ï¼ˆæ–‡ä»¶å·²ç‰©ç†åˆ é™¤ä½† DB ä»æ®‹ç•™çš„è®°å½•ï¼‰ã€‚
    - *Update*: æ”¯æŒä¸­æ–‡æ–‡ä»¶åçš„æ­£ç¡®è¯†åˆ«ã€‚

*   **Wiper (`wipe-data.py`)**: 
    - **å‡ºå‚é‡ç½®**: ä¸€é”®æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“è¡¨ã€é‡ç½®è‡ªå¢ ID (`sqlite_sequence`)ã€‚
    - **é…ç½®æ¸…æ´—**: é‡ç½® `data/*.json` åŠç›¸å†Œé…ç½® (`album-config.module.js`)ã€‚
    - **ç‰©ç†é”€æ¯**: å½»åº•åˆ é™¤æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„ç‰©ç†èµ„æºã€‚


---

## 4. API è·¯ç”±è§„èŒƒ

æ‰€æœ‰ API å®šä¹‰åœ¨ `routes.py` ä¸­ï¼Œå‰ç¼€å‡ä¸º `/api` æˆ–ç›´æ¥æš´éœ²ã€‚

| HTTP Method | Endpoint | å¯¹åº”çš„ Service æ–¹æ³• | æè¿° |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/cms/fetch` | `cms.fetch_module_tree()` | è·å–æ¨¡å—çš„æ–‡ä»¶æ ‘ (ä» DB) |
| `POST` | `/api/cms/node` | `cms._action_add/update...` | å¯¹èŠ‚ç‚¹æ‰§è¡Œå¢åˆ æ”¹æ“ä½œ (å†™ DB) |
| `POST` | `/upload` | `photos.handle_upload()` | ä¸Šä¼ å¹¶å¤„ç†å›¾ç‰‡ |
| `POST` | `/delete` | `photos.handle_delete()` | åˆ é™¤å›¾ç‰‡/èŠ‚ç‚¹ |
| `POST` | `/reorder` | `photos.handle_reorder()` | å›¾ç‰‡æ’åº |

---

## 5. æ•°æ®æµå‘

### å†™å…¥æµç¨‹ (Write Flow)
1.  **Frontend**: ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"ï¼Œ`api-client.module.js` å‘é€ POST è¯·æ±‚ã€‚
2.  **Routes**: `routes.py` æ¥æ”¶è¯·æ±‚ï¼Œè§£æ JSON å‚æ•°ã€‚
3.  **Services**: 
    -   `db_service` å°† Markdown å†…å®¹å†™å…¥ SQLiteã€‚
    -   `export_service` è¢«è§¦å‘ï¼Œä» DB è¯»å–å…¨é‡æ ‘ç»“æ„ã€‚
    -   `file_service` å°†æ ‘ç»“æ„å†™å…¥ `data/notes-tree.json`ã€‚
4.  **Response**: è¿”å› `{success: true}`ã€‚

### è¯»å–æµç¨‹ (Read Flow - Admin)
-   **Admin**: ç›´æ¥è¯·æ±‚ `/api/nodes` ä» SQLite è¯»å–ï¼ˆä¿è¯å®æ—¶æ€§ï¼‰ã€‚

### è¯»å–æµç¨‹ (Read Flow - Viewer)
-   **Viewer**: è¯·æ±‚é™æ€æ–‡ä»¶ `data/notes-tree.json`ï¼ˆæå¤§æå‡é€Ÿåº¦ï¼Œæ— éœ€ Python å‚ä¸ï¼‰ã€‚
