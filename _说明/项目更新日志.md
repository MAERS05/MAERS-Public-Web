# MAERS 项目更新日志

## 📋 目录 (Index)
- [2026-02-05] 核心模块统一 / SVG 硬编码清理 / Admin 布局修复
- [2026-02-05] 管理后台安全加固 / 终端回显升级 / 相册深度维护
- [2026-02-03] 侧边栏快速访问 / 相册排序与UI重构

## 2026-02-05 (Part 2)

### 🛡️ 管理后台安全加固 (Admin Security & Safety)
- **删除确认流程升级 (Secure Deletion)**:
    - 废弃了脆弱的 `confirm()` 确认框。现在删除页面或相册分类时，用户必须手动输入**文件名**或**分类 ID** 才能确认执行，极大降低了误删物理文件的风险。
    - 受影响模块：`index-admin.module.js`, `album-admin.module.js`。
- **物理文件联动清理 (Physical File Sync)**:
    - **相册分类删除**: 新增“物理粉碎”选项。确认删除分类时，会进一步询问是否删除服务器上的物理图片目录 (`photos/*/{id}`)。如确认，后端将执行 `shutil.rmtree` 彻底清理。

### ✨ 相册管理深度增强 (Album Maintenance)
- **相册 ID 可编辑性**: 开发者现在可以直接修改相册分类的 `id`，该 ID 直接对应底层的图片文件夹路径，增强了数据修正的灵活性。
- **自动化目录初始化**: 在添加新分类时，后端服务 (`album.py`) 现在会自动在服务器上同步创建对应的 `images`, `thumbnails`, `previews` 三级物理目录，不再需要手动创建文件夹。

### 🖥️ 首页管理系统 (Index Management System)
- **卡片化配置 (Card-based Config)**:
    - 首页图标与入口现已完全实现**动态配置化**。管理员可以通过 `admin-index.html` 直接管理首页的导航卡片（对应 `index-cards.json`）。
    - 支持在线修改卡片标题、副标题、SVG 图标路径以及关联的模块链接。
- **模块联动 (Module Integration)**:
    - 首页管理与 `modules.json` 深度联动，支持直接配置各模块的展示风格（Style）以及对应的后端数据路径。

### 🖥️ 终端交互与回显 (Terminal DX)
- **Studio Engine 标准化日志**:
    - 全面重易后端 (`_studio`) 的打印逻辑。所有服务 (`routes`, `cms`, `photos`, `album`, `music`, `bili`) 现在均采用统一的 `[ MODULE ] 图标 描述` 格式回显。
    - **中英双语回显**: 所有操作反馈改为中英双语（例如：`[ ALBUM ] 🆕 添加新分类 | Adding new category: ...`），赋予系统一种“实验设备”般的专业交互质感。
- **启动脚本美化**: `.bat` 启动器恢复为稳定版，保持简洁的启动逻辑。

### 🧩 前端细节修正 (Frontend Consistency)
- **SVG 引用标准化**: 将 `music.html` 中遗留的内联小房子 SVG 替换为统一的 `ui/music-home.svg` 资源文件，并通过 CSS Filter 实现了完美的主题色适配。

## 2026-02-05 (Part 1)

### ♻️ 架构重构 (Architecture Refactor)
- **核心模块统一 (Theme Unification)**:
    - 废弃并移除 `dynamic-style/script.module.js`，将其拖拽 (`Drag`)、缩放 (`Zoom`) 及主题切换逻辑完全整合至 `custom/shared/ui/theme.module.js`。
    - 实现了 `drag.css` 的自动注入机制，现在只需引入 `theme.module.js` 即可自动获得拖拽能力，大大简化了 `admin` 页面的依赖引用。
    - **Admin 页面标准化**: 所有 Admin 页面 (`admin-music`, `admin-photos`, `admin-cms`, `admin-album`) 均已切换为使用新的 `theme.module.js`，消除了代码冗余。

### 🎨 视觉与资源 (Visual & Assets)
- **图标硬编码清理 (SVG Extraction)**:
    - 识别并重构了遗留在 `admin-music.html` 和 `cms-recent.module.js` 中的硬编码 SVG 字符串和小图标。
    - 新增 `ui/music-home.svg` (音乐后台返回首页)
    - 新增 `ui/cms-history.svg` (CMS 快速访问)
    - 新增 `ui/cms-pin.svg` & `ui/cms-pin-slash.svg` (CMS 固定/取消固定)
    - **原生倾斜支持**: 将 "Pin" 图标的 45度倾斜效果直接写入 SVG 文件内部 (`transform="rotate(45, 12, 12)"`)，移除了 JS 中脆弱的 CSS `rotate` 样式。
- **布局修复**:
    - 移除了 Music Admin 标题中冗余的 `EDIT` 徽章，完美解决了左侧返回按钮被挤压换行的问题。
    - 修复了 `photos-view.module.js` 中标题渲染使用 `textContent` 导致 HTML 图标显示为源码的问题，改回 `innerHTML` 并加强了 XSS 防御意识。

### 🐛 修复 (Fixes)
- **灯箱冲突 (Lightbox Conflict)**: 修复了 `cms-lightbox.module.js` 错误拦截 Quick Access 按钮点击事件的问题（因按钮内含 `<img>`），新增了“忽略 `<button>` 内部图片”的判断逻辑。
- **数据维护工具 (Data Tools)**:
    - **中文路径支持**: `clean-data.py` 正则引擎升级，现在能正确识别和保留中文命名的图片文件（`photos/中文.jpg`），防止误删。
    - **全量重置增强**: `wipe-data.py` 新增对 `custom/` 目录下相册配置（JSON & JS）的重置逻辑，并引入 SQLite `sqlite_sequence` 重置，确保 ID 计数器彻底归零。


### 📱 移动端深度适配 (Mobile Deep Adaptation)
- **架构重组 (Architecture)**:
    - 建立 `custom/zmobile adaptation/` 专用目录，实现移动端样式与核心逻辑的物理隔离。
    - 新增 `mobile-photos.css`, `mobile-album.css`, `mobile-admin.css` 等组件级适配文件。
- **性能调优 (Performance)**:
    - **极速响应模式**: 在移动端 (`max-width: 1024px`) 强制禁用所有全局过渡动画 (`transition: none`)，消除主题切换时的渲染卡顿。
    - **去毛玻璃化**: 移动端强制移除高耗能的 `backdrop-filter` 和阴影，改用高不透明度纯色背景，显著降低 GPU 负载。
- **UI/UX 细节修正**:
    - **Index**: 修复缩放视图 (`shrink-view`) 下的内容裁剪问题；实现 Logo 颜色根据深浅主题自动反转 (CSS Filters)。
    - **Photos**: 移动端 Header 采用极简模式（隐藏标题文字，仅保留 SVG 图标），并使用实心背景防止内容透视干扰。
    - **Music**: 优化面包屑导航与跑马灯布局，在窄屏下自动换行 (`Wrap`)，防止信息重叠；新增播放列表拖拽手柄 (`⋮⋮`) 视觉提示。
    - **Literature**: 头部工具栏支持弹性换行，快速访问栏 (`Quick Access`) 改为横向滑动布局。
- **即时感知设计 (Affordance)**:
    - **S/A/M 按钮**: 新增 "Tap: Switch / Hold: Config" 明确操作指引。
    - **首页交互**: Logo 区域 hover 时显示 🔍 提示，暗示可缩放/查看。
    - **Literature 交互**: 新增 `mobile-literature.js` 独立适配脚本，将移动端触摸滑动 (`Touch Swipe`) 转换为虚拟滚轮事件，完美复刻桌面端流动翻页体验，解决了无法左右滑动阅览的问题。
    - **Photos 交互**: 新增 `mobile-photos.js` 适配脚本，使移动端用户在灯箱模式下能通过左右滑动切换图片。
    - **Book Flow 布局**: 针对移动端优化了 Flow 引擎的版面计算，将行高由 270px 压缩至 160px，确保三行书籍在手机竖屏下也能完整同屏显示，无裁剪。


## 2026-02-04

### ✨ 新增 (Features)
- **快速访问 (Quick Access)**：全新重构侧边栏，支持“固定访问”与“最近访问”分区，自动持久化存储。
- **图钉交互系统**：增加可交互图钉图标，支持固定/取消固定文件，具备 Hover 划线动画及深色模式适配。
- **Literature 深度集成**：支持从快速访问直接打开书籍（自动暂停 Flow 动画），并为视图切换按钮添加智能提示（Tooltip）。
- **多标签新建自动归类**：在筛选状态下新建文件，自动应用当前所有筛选标签。
- **筛选状态导航保持**：在筛选模式下进入/返回文件夹，自动在当前路径下维持筛选条件，不再重置为全量列表。
- **标签搜索自动展开**：搜索标签时，自动展开包含匹配项的父分类。

### 🐛 修复 (Fixes)
- **删除即时反馈 (Optimistic UI)**：修复筛选模式下删除文件需手动刷新的问题，改为强制立即移除 DOM 节点。
- **移动端资源缺失**：补全 `mobile-literature.css`，修复 404 报错。
- **模块引用错误**：移除 `admin-main.module.js` 中错误的 `Content` 引用。

### ♻️ 优化 (Refactor)
- **统一刷新逻辑**：重构 `refreshView`，使其根据当前视图模式（普通/筛选）智能决定刷新策略。
- **搜索作用域升级**：`Search` 模块支持基于当前文件夹路径的局部筛选。
- **相册排序重构**：重写相册排序逻辑，新增“时间倒序/正序”功能。支持解析多种格式的时间戳（包括 `20260115_..._72` 带序号高精度格式），完美解决同秒连拍图片的排序问题。
- **相册 UI 优化**：新增下拉式排序菜单 (`Dropdown Menu`)，适配深浅色模式，提升交互体验。


## 2026-02-04

### ✨ 新增 (Features)
- **CMS 智能导航系统**：
    - **自动定位上下文**：在搜索或标签筛选结果中点击文件时，支持自动跳转至文件所在的物理文件夹，并刷新网格视图。
    - **交互式预览确认**：在筛选模式下打开文件时，增加智能弹窗询问：“仅预览内容”或“跳转到所在目录”。
    - **全量视图遮罩**：在激活搜索或筛选时，面包屑导航栏自动显示 "All" 遮罩层，覆盖原有层级路径，明确标识“全局筛选视图”，消除用户困惑。
- **UI/UX 细节优化**：
    - **Music 模块**：优化添加按钮 (`.add-btn`) 交互体验，修复 Hover 时的颜色反转闪烁问题，统一为平滑缩放动画。
    - **Photo 模块**：统一相册头部“上传图片”与“排序”按钮的视觉风格，确保 Dark/Light 模式下的一致性。

### 🎨 视觉与交互 (Visual & Interaction)
- **SVG 全量化转型**：
    - 绝大部分 Emoji 图标（如 🗻、💿、🍸、🌿 等）已替换为专业 SVG 图标，确保在高 DPI 屏幕下的清晰度与视觉一致性。
    - **相册分类卡片**：全面采用 SVG 占位图体系，支持自定义 SVG 路径引用。
    - **管理端 UI 清理**：移除 CMS 管理端等区域的冗余 Emoji。
- **管理端交互重构**：
    - **严格撤销流程**：在 Admin 首页和 Album 管理页的弹出式编辑/新增弹窗中，实现“任一步骤取消即全程中止”的严格逻辑，防止脏数据提交。
    - **路径动态包装**：
        - **Admin 首页**：支持直接输入 SVG 路径，渲染时自动包装为 `<img>` 标签，保持 `modules.json` 数据纯净。
        - **Album 页面**：支持输入 SVG 路径自动转换为 HTML `<img>` 标签存储，并提供 `_extractSrc` 助手函数方便二次编辑。
    - **样式维护支持**：Admin 首页管理现在支持直接编辑和新增 `style` (CSS) 字段，实现页面风格的在线切换。


### 🐛 修复 (Fixes)
- **CMS 状态同步**：修复了筛选操作后面包屑状态未及时更新的 Bug（在 `Search.applyFilter` 中补充渲染调用）。
- **样式冲突**：移除了 `music-admin.css` 中与 Viewer 样式冲突的按钮 hover 规则。
