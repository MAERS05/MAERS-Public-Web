# MAERS 细节设计说明

本文档深入阐述项目中关键功能的实现细节与设计考量。

---

## 📋 目录 (Table of Contents)

- [1. 关键渲染路径与防闪烁](#1-关键渲染路径与防闪烁)
- [2. CMS 编辑器集成](#2-cms-编辑器集成)
- [3. 模块间通信机制](#3-模块间通信机制)
- [4. 音乐播放器架构](#4-音乐播放器架构)
- [5. 配置驱动架构 (Config-Driven Architecture)](#5-配置驱动架构-config-driven-architecture)
- [6. 基础设施服务模式 (Infrastructure Services)](#6-基础设施服务模式-infrastructure-services)
- [7. 高级状态管理与视图同步 (Advanced State & Sync)](#7-高级状态管理与视图同步-advanced-state--sync)
- [8. 快速访问与固定机制 (Quick Access & Pinning)](#8-快速访问与固定机制-quick-access--pinning)
- [9. 智能上下文导航 (Smart Context Navigation)](#9-智能上下文导航-smart-context-navigation)
- [10. 统一图标处理逻辑与管理端交互](#10-统一图标处理逻辑与管理端交互)


---

## 1. 关键渲染路径与防闪烁 (Flash Guard)

### 1.1 问题描述
在支持 Dark Mode 的网站中，如果 CSS/JS 加载延迟，用户会看到错误的浅色主题或无样式内容 (FOUC)。本项目采用 ES6 模块，其延迟加载特性加剧了此问题。

### 1.2 解决方案：同步阻塞脚本
在 `<head>` 中插入了一个极其微小的同步脚本 `flash-guard.js`。

**流程：**
1.  浏览器解析 HTML 到 `<head>`。
2.  遇到 `flash-guard.js`，暂停解析，下载并执行。
3.  **Script Execution**:
    -   检查 `LocalStorage` 中的主题偏好。
    -   立即给 `<html>` 添加 `light-mode` 类（如果是浅色）。
    -   **Critical**: 立即给 `<html>` 设置内联 `style="background-color: ..."` 作为 CSS 加载前的视觉兜底（Fallout）。
    -   立即插入一个全局 `style` 标签，给 `html.js-loading` 添加全屏背景遮罩。
4.  脚本执行完毕，浏览器继续解析 CSS 和 Body。
5.  页面渲染第一帧时，遮罩已存在，且底色正确，用户看不到 FOUC。
6.  **Cleanup (关键)**: 页面加载完毕 (DOMContentLoaded) 100ms 后，执行 `removeGuard()`：
    -   **移除内联 `background-color` 和 `color`**。这是防止后续主题切换失败的关键，确保 CSS 变量能接管样式。

### 1.3 移动端性能特化 (Mobile Optimization)
为了解决移动设备的渲染瓶颈，系统在 `mobile-global.css` 中实施了**不可见即不做 (Zero Waste)** 策略：
*   **Disabled**: 主题切换的所有 CSS `transition` 被强制设为 `none`。
*   **Hidden**: 全屏遮罩层 `#theme-mask` 在运行时被 `display: none`。
*   **Result**: 移动端的主题切换是瞬间完成的、无动画的。这种视觉降级换取了操作的绝对流畅。

---

## 2. CMS 编辑器集成

### 2.1 Vditor 选择
项目选择了 `Vditor` 作为 Markdown 编辑器，因其支持即时渲染 (WYSIWYG) 和分屏预览。

### 2.2 资源隔离
为了不影响访客加载速度，编辑器资源仅在 `admin-cms.html` 中引用。访客端使用轻量级的 `marked.js` 进行单纯的 HTML 渲染。

---

## 3. 模块间通信机制

核心模块（尤其是 CMS）采用显式依赖注入模式 (Dependency Injection) 以降低耦合度。不再依赖全局事件总线。

### 3.1 显式依赖与注入 (Dependency Injection)
除了基本的 `import`，核心模块（尤其是 CMS）中广泛采用了依赖注入模式。
*   **做法**: 模块不再直接导入具体的状态单例，而是通过 `init(State, Render...)` 函数接收依赖。
*   **优势**: 极大降低了耦合度。例如，`Drag` 模块不需要知道 `State` 来自哪里，只要接口一致即可。这也使得 Literature 模块能够轻松复用 CMS 的组件。

### 3.2 观察者模式 (Observer Pattern)
对于复杂的状态同步（如音乐播放进度），系统使用轻量级的订阅发布模式，但限制在 `MusicPlayer` 类内部，不对外暴露全局事件。

---

## 4. 音乐播放器架构

### 4.1 PiP (Picture-in-Picture)
播放器不仅是一个底栏，还支持悬浮窗模式。实现上通过改变容器的 `position: fixed` 和层级来实现，而非浏览器原生的 Video PiP API（因为我们需要显示歌词和封面）。

### 4.2 状态持久化
播放状态（当前歌曲、进度、音量）实时写入 `LocalStorage`。用户刷新页面或跳转页面后，通过 `flash-guard.js` 或初始化脚本恢复状态，实现"无缝播放"的错觉。

---

## 5. 配置驱动架构 (Config-Driven Architecture)

为了最大化复用 CMS 逻辑（既支持笔记，也支持文学，甚至相册配置），项目建立了一个静态配置中心 `module-config.module.js`。

### 5.1 核心思想
**Code Once, Configure Everywhere**.
CMS 模块不包含任何硬编码的字符串（如 "Study Notes" 或 "Literature"）。它仅仅在运行时询问 Config："模块名称是什么？图标是什么？允许用户修改标签吗？"

### 5.2 全局可访问性
为了让这个配置对全站透明，它被挂载在 `window.MAERS.ModuleConfig`。这是经过严格审视的架构决策，因为它仅仅包含只读的静态数据（Metadata），不包含状态，因此没有并发风险，且极大地简化了深层组件获取配置的复杂度。

### 5.3 数据结构示例
```javascript
{
    literature: {
        title: 'Literature',
        allowTags: true,
        allowMove: true,
        dataFile: 'data/literature-tree.json'
    }
}
```
CMS 通过读取 `dataType` 属性（如 `current=literature`）来自动切换行为模式。

---

## 6. 基础设施服务模式 (Infrastructure Services)

架构中严格区分了**业务逻辑**与**基础设施**。

### 6.1 定义
*   **业务逻辑 (Business Logic)**: 如相册渲染、音乐播放、笔记编辑。这些必须模块化，严格封装。
*   **基础设施 (Infrastructure)**: 如全局通知 (`Toast`)、主题状态 (`Theme`)。这些是“横切”整个应用的。

### 6.2 单例模式 (Singleton Pattern)
对于基础设施，采用挂载在 `window.MAERS` 下的单例模式。

**为什么不用 import?**
如果现在的 50+ 个业务文件都要报错，它们都需要写：
`import { Toast } from '../../shared/ui/toast.module.js'`
这产生了大量的样板代码 (Boilerplate) 和硬编码路径。

**设计决策**:
Toast 和 Theme 被视为**运行时环境 (Runtime Environment)** 的一部分。就像浏览器自带 `alert()` 和 `console.log()` 一样，MAERS 运行环境自带 `MAERS.Toast.error()`。这种设计极大地提升了开发体验 (DX)，同时并未破坏业务逻辑的解耦。

---

## 7. 高级状态管理与视图同步 (Advanced State & Sync)



### 7.1 智能导航与筛选保持 (Persistent Filter Navigation)
为了支持在筛选状态下穿梭文件夹（例如：只看 "#工作" 标签的文件，然后点进 "2024项目" 文件夹，依然只想看 "#工作" 的文件）。

**实现：**
在 `navigateTo` 和 `enterFolder` 中增强了逻辑：
*   **Context Awareness**: 导航前先检查 `Search` 模块是否有活跃的 filter。
*   **Dynamic Scope**: 如果有 filter，不再盲目重置为全量列表，而是调用 `Search.applyFilter()`。
*   **Scoped Search**: 修改了 `Search` 模块，使其支持基于当前 `pathNode.children` 进行局部筛选，而不仅仅是全局筛选。

这创造了一种连贯的 "筛选视界"，用户感觉自己是在一个 "过滤后的平行文件系统" 中漫游。

### 7.2 标签搜索联动 (Auto-Expand Drawer)
为了提升标签管理的效率，当用户搜索标签（如 "Sci-Fi"）时：
1.  系统不仅只显示匹配的标签。
2.  还会**自动展开** (Auto-Expand) 包含这些标签的父分类（如 "Genre"）。

这是通过在 `cms-tags.module.js` 的 `refreshDrawerList` 循环中，动态向 `expandedCategories` 集合添加匹配分类名来实现的。

---

## 8. 快速访问与固定机制 (Quick Access & Pinning)

### 8.1 模块隔离存储
为了避免不同模块（笔记、文学、随笔）的访问历史混淆，`cms-recent.module.js` 采用了动态存储键名策略。
*   **Key 生成**: `maers_recent_${moduleName}` (例如 `maers_recent_literature`)。
*   **好处**: 用户在“文学”模块的访问记录不会污染“笔记”模块的侧边栏。

### 8.2 固定 (Pinning) 逻辑设计
系统将用户“固定”的项目与“最近访问”的项目混合存储在同一个数组结构中（便于携带时间戳和元数据），但通过 `pinned: true` 属性进行区分。
*   **渲染分离**: 在 UI 层，数组被人为地拆分为 `Fixed Access` 和 `Recent Access` 两个 DOM 区域。
*   **交互**: 点击图钉图标会简单地切换该属性并重新排序/渲染。
*   **视觉反馈**: 实现了 `unpin-line` 动画，当鼠标悬停在已固定的图钉上时，显示一条划线，直观表达“取消固定”的语义。

### 8.3 跨模块视图集成 (CustomView Injection)
由于 Literature 模块拥有独特的 Flow Engine（3D 动画），直接调用 Editor 打开文件会导致性能浪费和遮挡问题。
系统实现了一种**视图注入**机制：
1.  **View 层扩展**: `cms-view.module.js` 新增 `CustomView` 插槽。
2.  **模块注册**: Literature 初始化时，将 `LiteratureView` 注册为 `CustomView`。
3.  **智能调用**: 当 Quick Access 触发打开请求时，View 层优先检查 `CustomView.openNode`。如果存在， Literature 模块会先负责**暂停动画**、**隐藏 3D 舞台**，然后再打开编辑器。这也是多态架构的体现。

---

## 9. 智能上下文导航 (Smart Context Navigation)

### 9.1 问题背景
在 CMS 系统支持“全局搜索”和“标签筛选”功能后，用户视图中的文件列表不再是单一文件夹的物理内容，而是跨文件夹的聚合结果。
当用户在这些聚合筛选视图中点击一个文件时，会面临上下文丢失的问题：
*   用户可能想**仅预览**文件内容，保留当前的筛选列表。
*   用户可能想**跳转到**文件所在的物理文件夹，查看其周边的相关文件。

### 9.2 设计机制
系统实现了一套智能的导航判定与交互流程：

1.  **自动检测上下文 (Context Awareness)**:
    当用户请求“打开/选中”一个节点时，系统首先检查：**目标节点是否包含在当前可视列表中？**
    *   **In-View**: 如果节点就在当前列表中（例如在普通文件夹内），直接高亮并打开。
    *   **Out-of-View**: 如果节点不在当前列表中（例如在搜索结果中，或者点击了面包屑的历史记录），则触发智能导航逻辑。

2.  **交互式决策 (Interactive Decision)**:
    在筛选/搜索模式下，针对"Out-of-View"的跳转，系统会弹出一模态对话框（Modal），提供两个明确选项：
    *   **仅预览 (Preview Only)**: 保持当前筛选列表不变，仅在右侧/浮层打开文件内容。
    *   **跳转目录 (Jump to Folder)**: 结束当前的筛选模式，跳转到目标文件所在的物理文件夹，并刷新网格视图以显示该文件夹下的所有内容。

3.  **全量视图遮罩 (All View Overlay)**:
    为了直观地区分“物理文件夹视图”和“虚拟筛选视图”，当进入搜索或标签筛选模式时：
    *   面包屑导航栏 (Breadcrumb) 会自动添加一个名为 `"All"` 的半透明遮罩层。
    *   **视觉隐喻**: 这个遮罩层覆盖在具体的路径之上，像一层滤镜，暗示用户当前看到的是基于全局的筛选结果，而非特定路径下的内容。
    *   **交互**: 点击遮罩层的关闭按钮 (X)，可立即清除所有筛选条件，退回到最后所在的物理文件夹。

### 9.3 实现细节
*   **Search Scope**: 在 `cms-search.module.js` 中，搜索不再是一次性的过滤，而是具备 Scope 属性（Global vs Local）。
*   **State Sync**: 导航发生时，`cms-state` 负责同步更新 `currentPath` 和 `filterMode` 状态，确保 URL 和视图的一致性。

---

## 10. 统一图标处理逻辑与管理端交互

### 10.1 数据层差异化存储
虽然全站统一向 SVG 转型，但基于职责隔离原則，系统保留了两种图标存储逻辑：
-   **路径驱动 (Raw Path)**: 首页管理端 (`modules.json`) 仅存储 `ui/icon.svg`。渲染器实时判断 `isPath` 并动态包装。这保证了数据文件的极度纯净和可读性。
-   **片段驱动 (HTML Snippet)**: 相册管理端 (`album-config.json`) 存储完整 HTML 片段。这允许在配置层面微调图标样式（如宽高、滤镜），无需修改 JS 代码。

### 10.2 管理端安全事务交互
针对“多步弹窗”可能引发的数据不一致风险，设计了**原子化撤销 (Atomic Abort)** 机制：
1.  **链路阻断**: 在连续的名称、图标、路径、样式输入流程中，一旦某一步 `prompt` 被用户点击“取消” (返回 `null`)，函数立即拦截并终止，绝不执行后续 API 调用。
2.  **默认值智能提取**: 相册管理的编辑框会自动调用 `_extractSrc` 正则助手，从 `<img>` 标签中剥离出纯路径展示给用户，避免用户直接面对复杂的 HTML 源码。
3.  **样式动态注入支持**: `Admin Core` 现在显式暴露了 `style` 字段的维护入口，允许通过管理端直接配置模块对应的 CSS 皮肤，实现了 UI 风格的配置化管理。



---

## 11. 移动端适配策略 (Mobile Adaptation Strategy)

### 11.1 物理隔离架构 (Physical Isolation)
为了保证 Desktop 端复杂交互逻辑（Flow Engine, Masonry）的稳定性，移动端适配不采用传统的 "Media Query Patching"（在各个 CSS 文件内打补丁）模式，而是采用**物理文件隔离**。
*   **目录**: `custom/zmobile adaptation/`。
*   **机制**: 所有移动端特有的 CSS 规则都被抽取到独立文件中（如 `mobile-music.css`），并在构建或 HTML 头部以 `<link>` 或 `@import` 引入。
*   **权重管理**: 适配文件中的选择器统一添加 `body` 前缀（如 `body .container`），利用 CSS 优先级自然覆盖原有样式，无需大量 `!important`，维护性更高。

### 11.2 极致性能策略 (Zero Waste Performance)
移动端尤其是中低端设备，在处理 WebGL (3D Earth), Backdrop Filter (毛玻璃), Box Shadow (大阴影) 时极其吃力。
*   **去特效化**: 在 `max-width: 1024px` 下，强制移除所有毛玻璃和复杂阴影，改用高不透明度纯色背景。这虽然牺牲了部分视觉深度，但换取了绝对的渲染帧率。
*   **零过渡 (Zero Transition)**: 强制设置 `* { transition: none !important }`。在昼夜切换时，颜色瞬间改变，消除了 GPU 在重绘大面积渐变时的卡顿感，给用户“极速响应”的心理感受。

### 11.3 即时感知设计 (Instant Awareness / Affordance)
针对移动端缺乏 Cursor Hover 状态的特性，系统显式化了所有隐式交互：
1.  **功能自解释**: 自动/手动切换按钮 (Auto Mode Btn) 的 Tooltip 从简单的状态描述改为操作指引 `"Tap: Switch / Hold: Config"`，降低了探索门槛。
2.  **视觉抓手**: 音乐播放列表项右侧增加 `⋮⋮` 抓手图标，直观传达“可拖拽排序”的语义，无需用户去猜长按哪里。
3.  **交互暗示**: 首页 Hover 标题栏时浮现 `🔍` 图标，暗示该区域具备缩放交互能力。

### 11.4 视口空间防御 (Viewport Defense)
针对移动端有限的纵向空间和刘海屏/动态地址栏干扰：
*   **Photos Header**: 采用“极简模式”，隐藏标题文字，仅保留 SVG 图标，极大节省头部空间。
*   **Music Wrap**: 允许面包屑导航和跑马灯文字在窄屏下自动换行或隐藏，防止内容相互挤压导致布局崩坏。
*   **Quick Access**: 改为横向滑动容器 (`overflow-x: auto`)，确保在不增加高度的前提下容纳无限多的快捷入口。
