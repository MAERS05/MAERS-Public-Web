# MAERS 文件功能说明图谱

本文档提供了项目中所有关键文件的功能字典。如需修改某个功能但不知从何下手，请查阅此表。

---

## 📋 目录 (Table of Contents)

1. [根目录文件 (Root)](#1-根目录文件-root)
2. [后端核心引擎 (_studio)](#2-后端核心引擎-_studio)
3. [CMS 模块 (custom/cms)](#3-cms-模块-customcms)
4. [相册模块 (custom/album)](#4-相册模块-customalbum)
5. [音乐模块 (custom/music)](#5-音乐模块-custommusic)
6. [文学模块 (custom/literature)](#6-文学模块-customliterature)
7. [首页模块 (custom/index)](#7-首页模块-customindex)
8. [移动端适配 (custom/zmobile adaptation)](#8-移动端适配-customzmobile-adaptation)
9. [关键基础设施 (Infrastructure)](#9-关键基础设施-infrastructure)

---

## 1. 根目录文件 (Root)

| 文件名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `index.html` | Entry | **网站首页**。包含 3D 地球特效、身份卡片和导航入口。 |
| `notes.html` | Entry | **笔记列表页 (访客)**。读取 JSON 数据展示笔记树和 Markdown 内容。 |
| `photos.html` | Entry | **相册瀑布流页 (访客)**。展示摄影作品，支持分类筛选和灯箱查看。 |
| `music.html` | Entry | **音乐播放器页 (访客)**。全屏沉浸式播放器界面。 |
| `admin-portal.html` | Entry | **后台管理首页**。管理员 Dashboard 入口。 |
| `admin-cms.html` | Entry | **笔记编辑器 (管理)**。包含完整的文件树操作、Vditor 编辑器和保存功能。 |
| `admin-album.html` | Entry | **相册/分类管理器**。画廊模块的管理后台，支持多层级分类和图片上传。 |
| `maers-version-controller.js` | Service Worker | **缓存与版本控制器**。拦截网络请求追加版本号。修改此文件中的 VERSION 可触发全站更新。 |
| `literature.html` | Entry | **文学长廊 (访客)**。Flow Engine 驱动的沉浸式书籍阅览室。 |


---

## 2. 后端核心引擎 (_studio)

路径：`_studio/` (Python 环境)

| 文件名 | 描述 |
| :--- | :--- |
| `server.py` | **服务器入口**。初始化原生 HTTP Server，配置静态资源路径，启动 HTTP 服务。 |
| `routes.py` | **路由控制器**。定义所有 `/api/*` 接口，接收前端请求并分发给 Service 层。包含页面创建/物理删除逻辑，并具备 **[PAGE] 双语控制台回显**。 |
| `config.py` | **配置文件**。定义端口号、数据库路径、上传目录等全局常量。 |
| `clean-data.py` | **全量清理工具**。扫描 `cms.db` 和 `gallery.db`，清理所有未引用的图片文件及无效数据库记录。具备中文路径识别能力。 |
| `wipe-data.py` | **数据销毁工具**。清空数据库和物理图片，将网站重置为“出厂状态”。 |
| `services/` | **业务逻辑层文件夹** (所有服务均接入模块化**双语日志系统**) |
| ├── `cms.py` | **CMS服务**。处理 Notes/Literature/Record 数据。支持节点增删改查、重排及封面图自动物理联动清理。控制台回显格式：`[ CMS ]`。 |
| ├── `album.py` | **分类服务**。管理相册分类、排序。支持**自动物理目录初始化**以及**分级安全删除 (提示输入ID)**。控制台回显：`[ ALBUM ]`。 |
| ├── `photos.py` | **相册服务**。处理图片上传、哈希去重恢复及物理粉碎。控制台回显：`[ PHOTOS ]`。 |
| ├── `music.py` | **音乐服务**。处理歌单增删改、音轨剔除与重置。控制台回显：`[ MUSIC ]`。 |
| └── `bili.py` | **B站服务**。获取B站视频信息的辅助工具，支持联网状态自动回显。控制台回显：`[ BILI ]`。 |
| `启动管理后台(server.py).bat` | **一键启动**。一键启动 Python 后端及 Dashboard，作为服务的“主控制台”展示各模块日志。 |
| `清理垃圾数据(clean-data.py).bat` | **维护工具**。一键执行数据清理，移除孤儿图片。 |
| `清空所有数据(wipe-data.py).bat` | **危险工具**。一键抹除全站用户数据。 |
| `快捷打开文件(open-file.py).bat` | **辅助工具**。快速打开当前正在编辑的物理文件。 |

---

## 3. CMS 模块 (custom/cms)

此模块负责笔记的展示与管理，逻辑最为复杂。

### 3.1 访客端 (viewer/)
路径：`custom/cms/viewer/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-view.module.js` | **主视图控制器**。协调渲染、事件绑定和状态管理，是 CMS 访客端的入口。 |
| `cms-render.module.js`| **渲染引擎**。负责生成文件夹树、笔记列表、面包屑及**全量筛选视图遮罩 (Breadcrumb Overlay)**。 |
| `cms-events.module.js`| **事件监听器**。处理点击、搜索、快捷键，并实现**上下文智能导航 (Smart Context Navigation)**。 |
| `cms-state.module.js` | **状态管理**。维护当前路径、选中节点、展开状态等数据。 |
| `cms-search.module.js`| **搜索引擎**。实现前端纯文本搜索、标签过滤及**动态视图刷新联动**。 |
| `cms-tags.module.js` | **[ facade ] 标签入口**。整合抽屉 UI 与过滤逻辑，实现标签管理的主要接口。 |
| `tags/cms-tags-drawer.module.js`| **标签抽屉 (UI)**。负责侧边栏渲染、多选球交互、批量搬家交互及定位闪烁动画。 |
| `tags/cms-tags-filter.module.js`| **标签过滤器 (Logic)**。独立封装筛选算法，支持多选并集/交集计算及 UI 状态同步。 |
| `cms-recent.module.js`| **快速访问**。管理“最近访问”和“固定访问”的文件列表，支持模块隔离存储 (Notes/Lit/Record) 和图钉操作。 |
| `cms-lightbox.module.js`| **灯箱组件**。CMS 专用的Markdown图片查看器。 |
| `cms-base.css` | **基础样式**。Grid 布局、响应式框架，不包含色彩主题。 |
| `cms-theme-default.css`| **默认主题**。定义文件夹图标、颜色、圆角等视觉样式。 |
| `record.css` | **Record 样式**。Records 页面专用样式，包含针对 Record 图标的昼夜模式反转逻辑。 |

### 3.2 管理端 (admin/)
路径：`custom/cms/admin/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-controller.module.js`| **管理端主控**。扩展了访客端功能，封装 API 调用（含 `reorder` 排序接口）。 |
| `cms-admin.module.js` | **UI 交互控制器**。负责工具栏按钮事件、弹窗交互、批量操作（BatchManager）及**乐观 UI 删除 (Optimistic UI)**。 |
| `cms-editor.module.js` | **编辑器集成**。封装 `Vditor` 实例，处理 Markdown 的加载与保存。 |
| `cms-drag.module.js` | **拖拽排序**。使用 `SortableJS` 实现文件和文件夹的拖拽移动、排序。 |
| `cms-editor.css` | **管理样式**。增加工具栏、右键菜单、编辑器容器等特定样式（主要由 Vditor 样式组成）。 |

---

## 4. 相册模块 (custom/album)

路径：`custom/photos/` (UI/逻辑) 与 `custom/album/` (分类/管理外壳)

*   **Viewer (访客端)**: 主力在 `custom/photos/viewer/`，由 `photos.html` 加载。
*   **Admin (管理端)**: 主力在 `custom/album/admin/`，由 `admin-album.html` 加载 (引用 `custom/album/admin-main.module.js`)。

| 文件名 | 目录 | 描述 |
| :--- | :--- | :--- |
| `photos-view.module.js` | `photos/viewer` | **瀑布流视图**。计算图片位置实现 Masonry 布局，处理懒加载。 |
| `photos-header-btn.css` | `photos/viewer` | **排序菜单样式**。适配 Dark Mode 的下拉菜单。 |
| `photos-viewer.css` | `photos/viewer` | **基础样式**。定义瀑布流容器、图片卡片及响应式布局。 |
| `photos-lightbox.module.js`| `photos/viewer` | **灯箱组件**。全屏查看图片，支持手势缩放和键盘切换。 |
| `admin-main.module.js` | `album` | **管理入口**。初始化相册管理 Dashboard。 |
| `photos-controller.module.js`| `photos/admin` | **图片逻辑**。处理图片上传、物理删除及 API 调用。 |
| `photos-upload.module.js` | `photos/admin` | **上传组件**。拖拽上传区域 UI。 |

---

## 5. 音乐模块 (custom/music)

路径：`custom/music/`

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。初始化播放器实例。 |
| `music-player-core.module.js`| `viewer/` | **核心引擎**。封装 `Audio` 对象，实现播放/暂停、音量控制及 `on/emit` 事件发布。 |
| `music-control.module.js` | `viewer/` | **逻辑控制器**。处理播放模式（随机/循环）、列表管理及上一曲/下一曲切换逻辑。 |
| `music-render.module.js` | `viewer/` | **渲染引擎**。负责生成播放列表 DOM、更新封面图及高亮当前歌曲。 |
| `music-ui.module.js` | `viewer/` | **UI 交互**。处理进度条拖动、封面旋转动画及界面事件绑定。 |
| `music-player-iframe.module.js`| `viewer/` | **扩展播放源**。支持 YouTube/Bilibili 等 Iframe 嵌入式播放。 |
| `music-player-pip.module.js`| `viewer/` | **画中画模式**。处理悬浮窗状态下的特殊 UI 逻辑。 |
| `music-state.module.js` | `viewer/` | **状态持久化**。监听核心事件，负责将播放进度和列表位置保存到 LocalStorage。 |
| `music.css` | `viewer/` | **模块样式**。定义播放器沉浸式界面及动画，包含分类图标 (music-class) 的主题适配。 |

---

## 6. 文学模块 (custom/literature)

路径：`custom/literature/`

**核心特性**：Flow Engine (虚拟滚动流动引擎) + Polymorphic CMS (复用 CMS 内核)。

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。注入 CMS 依赖，初始化 Flow Engine。 |
| `literature-view.module.js` | `viewer/` | **Flow Engine (核心)**。实现 3D 路径计算、虚拟滚动优化 (Virtual Scrolling) 及 WebP 封面渲染。 |
| `literature.css` | `viewer/` | **文学样式**。定义 3D 视口、书籍卡片样式及独特的交互动画。 |
| `literature-reset.css` | `viewer/` | **样式重置**。**[CRITICAL]** 强制覆盖 CMS 通用样式 (如 Clip-path, Transforms)，还原书籍的扁平化设计。 |

---

## 7. 首页模块 (custom/index)

| 路径 | 文件 | 描述 |
| :--- | :--- | :--- |
| `custom/index/` | `index-3d.module.js` | **3D 地球**。首页旋转地球的 Canvas 实现。 |
| `custom/index/admin/` | `index-admin.module.js` | **首页管理模块**。负责首页卡片 (`data/index-cards.json`) 的增删改查。 |
| `custom/admin-portal/admin/` | `main.module.js` | **后台管理主入口**。协调 AdminPortal 的初始化与核心逻辑加载。 |
| `data/` | `admin-portal.json` | **后台模块配置**。定义管理后台显示的各个子模块及其入口。 |
| `custom/admin-portal/admin/` | `admin-portal.module.js` | **后台管理核心**。处理全站模块的数据读写、页面物理创建与销毁。 |
| `custom/admin-portal/viewer/` | `admin-portal.css` | **管理样式**。包含管理后台的布局、卡片样式及主题适配逻辑。 |

---

## 8. 移动端适配 (custom/zmobile adaptation)

路径：`custom/zmobile adaptation/`

**策略**: 物理隔离。主文件负责 Desktop 布局，此目录下的文件专门负责 Mobile/Tablet 端的样式覆盖。所有样式选择器均加 `body` 前缀以提升权重。

| 文件名 | 对应主文件 | 描述 |
| :--- | :--- | :--- |
| `mobile-global.css` | `style.css` | **全局适配**。处理容器内边距、**[High Perf]** 禁用毛玻璃/阴影/过渡动画以提升手机流畅度。 |
| `mobile-cms.css` | `cms-base.css` | **CMS 适配**。搜索框全宽、工具栏堆叠、网格列数自适应。 |
| `mobile-music.css` | `music.css` | **音乐适配**。播放列表堆叠布局、面包屑自动换行、跑马灯与拖拽手柄优化。 |
| `mobile-index.css` | `index.css` | **首页适配**。处理 Logo/Slogan 在缩放视图 (`shrink-view`) 下的防裁剪与布局调整，以及**主题图标适配逻辑**。 |
| `mobile-literature.css` | `literature.css` | **文学适配**。Quick Access 横向滑动、头部工具栏换行支持。 |
| `mobile-literature.js`  | `literature-view.module.js` | **文学交互适配**。监听 Touch 事件并转换为 Wheel 事件，驱动桌面端 Flow Engine 在移动端实现滑动翻页。 |
| `mobile-photos.css` | `photos-viewer.css` | **相册适配**。极简 Header (隐藏文字保留 SVG)、移除半透明背景、单/双列网格优化。 |
| `mobile-photos.js`  | `photos-view.module.js` | **相册交互适配**。监听 Touch 事件并转换为 Wheel 事件，实现灯箱在移动端的左右滑动切图。 |
| `mobile-album.css` | `album-viewer.css` | **分类适配**。适配分类卡片网格布局。 |
| `mobile-admin.css` | `*-admin.css` | **管理端适配**。优化 Admin 侧边栏与表单在移动端的显示。 |
| `mobile-spatial-nav.css`| - | **空间导航适配**。处理电视/遥控器模式下的焦点样式。 |

---

## 9. 关键基础设施 (Infrastructure)

这些文件支撑着整个网站的运行，属于横切关注点。

### 9.1 共享基础设施 (shared/)
| 文件名 | 路径 | 描述 |
| :--- | :--- | :--- |
| `flash-guard.js` | `shared/` | **[CRITICAL] 防闪烁守卫**。HTML 头部同步阻塞脚本，在渲染前注入遮罩和主题类，防止 FOUC。整合了 LocalStorage 读取、Favicon 注入和主题初始化。 |
| `style-injector.module.js`| `shared/` | **样式注入器**。负责动态加载模块特定的 CSS 文件。 |
| `module-config.module.js` | `shared/` | **配置中心**。定义了 CMS 的所有元数据（图标、允许的特性、数据文件路径）。 |
| `layout.module.js` | `shared/` | **布局初始化**。渲染公共 Header/Menu。 |
| `theme.module.js` | `shared/` | **[ facade ] 主题入口**。协调子模块（Core, Drag, Zoom）并提供统一的接口。核心依赖。 |
| `theme-core.module.js` | `shared/theme/` | **[CORE] 状态心跳**。处理主题状态、配置持久化及 Iframe 交互逻辑。 |
| `theme-drag.module.js` | `shared/theme/` | **[DRAG] 拖拽引擎**。封装全局 Admin 拖拽、长按检测与视觉反馈。 |
| `theme-zoom.module.js` | `shared/theme/` | **[ZOOM] 缩放引擎**。独立控制全站 UI 视口缩放与边界判定。 |
| `spatial-nav.module.js` | `shared/` | **空间导航**。为非首页页面提供 3D 悬浮导航球。 |
| `simple-main.module.js` | `shared/` | **通用页面入口**。为 Me, Space, Games 等静态页面提供快速初始化逻辑。 |
| `utils.module.js` | `shared/` | **公共工具库**。包含 HTML 转义 (XSS 防护)、拼音模糊匹配等核心工具。 |
| `toast.module.js` | `shared/` | **全局通知服务**。提供 `MAERS.Toast` 单例，实现统一的反馈弹窗。 |

### 9.2 全局样式 (static-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `theme.css` | **[CORE] 变量定义**。定义全站色彩变量，驱动深色模式。 |
| `style.css` | **全局重置与布局**。包含 Reset, Typography, 和全屏动态背景。 |
| `components.css` | **通用组件库**。定义按钮、输入框、卡片等复用交互样式。 |
| `spatial-nav.css` | **空间导航样式**。包含 3D 悬浮球布局与**主题图标适配逻辑**。 |
| `drag.css` | **拖拽相关样式**。提供 Admin 拖拽时的视觉反馈（如虚线框、禁止符号）。 |

### 9.3 管理端核心 (data-manage/ & custom/cms/admin/)
| 文件名 | 路径 | 描述 |
| :--- | :--- | :--- |
| `admin-base.module.js` | `data-manage/` | **[ facade ] 管理基石**。整合子模块提供统一导出，并维持老版本引用兼容。 |
| `admin-manager.module.js` | `data-manage/admin/` | **列表管理器**。包含 `BatchItemManager` 类，处理状态快照、批量撤销。 |
| `admin-ui.module.js` | `data-manage/admin/` | **管理端 UI**。整合了 `SaveButton` 动态组件与交互反馈系统。 |
| `admin-button-helper.module.js` | `data-manage/admin/` | **按钮渲染器**。负责 CRUD 操作按钮的自动化注入与样式同步。 |
| `api-client.module.js` | `data-manage/` | **API 客户端**。统一封装 Fetch 请求，处理权限与错误回显。 |
| `cms-controller.module.js`| `custom/cms/admin/` | **CMS 主控**。扩展 Viewer 逻辑，封装 `reorder` 等 CMS 专属 API。 |
| `admin-main.module.js` | `custom/cms/admin/` | **[CORE] CMS 调度器**。协调 FileTree 与 Tags 两个管理器的脏检查与保存同步。 |

### 9.4 标签系统子模块 (custom/cms/viewer/tags/)
| 文件名 | 描述 |
| :--- | :--- |
| `cms-tags.module.js` | **[ facade ] 标签入口**。整合抽屉与过滤器，对外部逻辑（View/Search）提供统一接口。 |
| `cms-tags-drawer.module.js`| **标签抽屉 (UI)**。负责渲染、多选球、批量移动交互及 Auto-Scroll 逻辑。 |
| `cms-tags-filter.module.js`| **标签过滤器 (Logic)**。独立封装筛选算法，与 `Search` 模块实时联动。 |

### 9.5 UI 资源与配置
| 文件名 | 路径 | 描述 |
| :--- | :--- | :--- |
| `*.svg` | `ui/` | **全局图标库**。采用 SVG 引用以支持 CSS Filter 主题变色。 |
| `index-cards.json` | `data/` | **首页配置**。定义首页卡片的链接、标题与图标路径。 |
| `config.js` | `custom/` | **全局环境配置**。定义 API_BASE 等常量，通过 `MAERS.Config` 全局访问。 |
