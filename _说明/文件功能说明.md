# MAERS 文件功能说明图谱

本文档提供了项目中所有关键文件的功能字典。如果您想修改某个功能但不知道改哪个文件，请查阅此表。

---

## 📋 目录 (Table of Contents)

1. [根目录文件 (Root)](#1-根目录文件-root)
2. [后端核心引擎 (_studio)](#2-后端核心引擎-_studio)
3. [CMS 模块 (custom/cms)](#3-cms-模块-customcms)
4. [相册模块 (custom/album)](#4-相册模块-customalbum)
5. [音乐模块 (custom/music)](#5-音乐模块-custommusic)
6. [文学模块 (custom/literature)](#6-文学模块-customliterature)
7. [首页模块 (custom/index)](#7-首页模块-customindex)
8. [关键基础设施 (Style, Data, Dynamic)](#8-关键基础设施)

---

## 1. 根目录文件 (Root)

| 文件名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `index.html` | Entry | **网站首页**。包含 3D 地球特效、身份卡片和导航入口。 |
| `notes.html` | Entry | **笔记列表页 (访客)**。读取 JSON 数据展示笔记树和 Markdown 内容。 |
| `photos.html` | Entry | **相册瀑布流页 (访客)**。展示摄影作品，支持分类筛选和灯箱查看。 |
| `music.html` | Entry | **音乐播放器页 (访客)**。全屏沉浸式播放器界面。 |
| `admin.html` | Entry | **后台管理首页**。管理员 Dashboard 入口。 |
| `admin-cms.html` | Entry | **笔记编辑器 (管理)**。包含完整的文件树操作、Vditor 编辑器和保存功能。 |
| `admin-photos.html`| Entry | **照片管理器 (管理)**。提供图片上传、删除和分类管理功能。 |
| `maers-version-controller.js` | Service Worker | **缓存与版本控制器**。拦截网络请求追加版本号。修改此文件中的 VERSION 可触发全站更新。 |
| `literature.html` | Entry | **文学长廊 (访客)**。Flow Engine 驱动的沉浸式书籍阅览室。 |


---

## 2. 后端核心引擎 (_studio)

路径：`_studio/` (Python Flask 环境)

| 文件名 | 描述 |
| :--- | :--- |
| `server.py` | **服务器入口**。初始化 Flask App，配置静态资源路径，启动 HTTP 服务。 |
| `routes.py` | **路由控制器**。定义所有 `/api/*` 接口，接收前端请求并分发给 Service 层。 |
| `config.py` | **配置文件**。定义端口号、数据库路径、上传目录等全局常量。 |
| `clean-data.py` | **全量清理工具**。扫描 `cms.db` 和 `gallery.db`，清理所有未引用的图片文件及无效数据库记录。 |
| `wipe-data.py` | **数据销毁工具**。清空数据库和物理图片，将网站重置为“出厂状态”。 |
| `services/` | **业务逻辑层文件夹** |
| ├── `cms.py` | **CMS服务**。处理 Notes/Literature/Record 数据。支持节点增删改查及**拖拽重排 (Reorder)**。操作后自动生成 `*-tree.json`。 |
| ├── `album.py` | **分类服务**。管理相册的顶级分类、排序及元数据。操作后同步 `CATEGORY_CONFIG`。 |
| ├── `photos.py` | **相册服务**。处理图片上传与管理 (Pillow)。操作后自动生成 `photos-data.json`。 |
| ├── `music.py` | **音乐服务**。处理歌单增删改。操作后自动生成 `music-data.json`。 |
| └── `bili.py` | **B站服务**。获取B站视频信息的辅助工具。 |
| `启动管理后台(server.py).bat` | **一键启动**。启动后端 API 服务并自动在浏览器打开管理后台。 |
| `清理垃圾数据(clean-data.py).bat` | **维护工具**。一键执行数据清理，移除孤儿图片。 |
| `清空所有数据(wipe-data.py).bat` | **危险工具**。一键抹除全站用户数据。 |
| `快捷打开文件(open-file.py).bat` | **辅助工具**。快速打开当前正在编辑的物理文件。 |

---

## 3. CMS 模块 (custom/cms)

这是最复杂的模块，负责笔记的展示与管理。

### 3.1 访客端 (viewer/)
路径：`custom/cms/viewer/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-view.module.js` | **主视图控制器**。协调渲染、事件绑定和状态管理，是 CMS 访客端的入口。 |
| `cms-render.module.js`| **渲染引擎**。负责生成文件夹树、笔记列表和面包屑的 HTML 结构。 |
| `cms-events.module.js`| **事件监听器**。处理点击、搜索、键盘快捷键等用户交互事件。 |
| `cms-state.module.js` | **状态管理**。维护当前路径、选中节点、展开状态等数据。 |
| `cms-search.module.js`| **搜索引擎**。实现前端纯文本搜索和标签过滤功能。 |
| `cms-tags.module.js` | **标签系统**。处理标签的提取、渲染和过滤逻辑。 |
| `cms-base.css` | **基础样式**。Grid 布局、响应式框架，不包含色彩主题。 |
| `cms-theme-default.css`| **默认主题**。定义文件夹图标、颜色、圆角等视觉样式。 |

### 3.2 管理端 (admin/)
路径：`custom/cms/admin/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-controller.module.js`| **管理端主控**。扩展了访客端功能，封装 API 调用（含 `reorder` 排序接口）。 |
| `cms-admin.module.js` | **UI 交互控制器**。负责工具栏按钮事件、弹窗交互、批量操作（BatchManager）及保存逻辑（PerformSave）。 |
| `cms-editor.module.js` | **编辑器集成**。封装 `Vditor` 实例，处理 Markdown 的加载与保存。 |
| `cms-drag.module.js` | **拖拽排序**。使用 `SortableJS` 实现文件和文件夹的拖拽移动、排序。 |
| `admin-cms.css` | **管理样式**。增加工具栏、右键菜单、编辑器容器等特定样式。 |

---

## 4. 相册模块 (custom/album)

路径：`custom/album/` 或 `custom/photos/` (注意：实际代码在 `custom/photos` 中，HTML入口为 `photos.html`)

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。根据 URL 判断是管理员还是访客，动态加载对应模块。 |
| `photos-view.module.js` | `viewer/` | **瀑布流视图**。计算图片位置实现 Masonry 布局，处理懒加载。 |
| `photos-lightbox.module.js`| `viewer/` | **灯箱组件**。全屏查看图片，支持手势缩放和键盘切换。 |
| `photos-controller.module.js`| `admin/` | **管理控制器**。处理图片上传接口调用、删除确认等逻辑。 |
| `photos-upload.module.js` | `admin/` | **上传组件**。实现拖拽上传区域，显示上传进度条。 |

---

## 5. 音乐模块 (custom/music)

路径：`custom/music/`

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。初始化播放器实例。 |
| `music-player-core.module.js`| `viewer/` | **播放核心**。封装 `Audio` / `Iframe` 对象。实现了**事件驱动 (`on/emit`)** 机制来管理播放状态。 |
| `music-player-ui.module.js` | `viewer/` | **UI 控制**。处理进度条拖动、封面旋转、歌词滚动动画。 |
| `music-state.module.js` | `viewer/` | **状态持久化**。监听核心事件，负责将播放进度和列表位置保存到 LocalStorage。**无轮询消耗**。 |
| `music-player-pip.module.js`| `viewer/` | **画中画模式**。处理悬浮窗状态下的特殊 UI 逻辑。 |
| `music-visualizer.module.js` | `viewer/` | **音频可视化**。使用 Web Audio API 和 Canvas 绘制频谱跳动效果。 |
| `music-data.module.js` | `viewer/` | **数据层**。负责加载歌单 JSON 数据。 |

---

## 6. 文学模块 (custom/literature)

路径：`custom/literature/`

**核心特性**：Flow Engine (虚拟滚动流动引擎) + Polymorphic CMS (复用 CMS 内核)。

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。注入 CMS 依赖，初始化 Flow Engine。 |
| `literature-view.module.js` | `viewer/` | **Flow Engine (核心)**。实现 3D 路径计算、虚拟滚动优化 (Virtual Scrolling) 及 WebP 封面渲染。 |
| `literature.css` | `viewer/` | **文学样式**。定义 3D 视口、书籍卡片样式及独特的交互动画。 |
| `literature-reset.css` | `viewer/` | **样式重置**。**[CRITICAL]** 强制覆盖 CMS 通用样式 (如 Clip-path, Transforms)，还原书籍的扁平化设计。 |

---

## 7. 首页模块 (custom/index)

| 路径 | 文件 | 描述 |
| :--- | :--- | :--- |
| `custom/index/` | `index-3d.module.js` | **3D 地球**。首页旋转地球的 Canvas 实现。 |
| `custom/index/admin/` | `admin-core.module.js` | **Admin Core**。虽然放在 index 下，实际上是**全站 Admin 的公共基类** (BatchManager, SaveButton 等)。 |

---

## 8. 关键基础设施

这些文件支撑着整个网站的运行。

### 7.1 动态脚本 (dynamic-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `flash-guard.js` | **[CRITICAL] 防闪烁守卫**。同步加载的脚本，在渲染前注入遮罩和主题类，防止 FOUC。包含 LocalStorage 读取和 Favicon 注入。 |
| `theme-init.module.js`| **主题初始化**。ES6 模块，负责页面加载后的主题切换逻辑 (Toggle Button)。 |

### 7.2 全局样式 (static-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `theme.css` | **[CORE] 变量定义**。定义 `--bg-base`, `--text-main` 等 CSS 变量，是深色模式的核心。 |
| `style.css` | **全局重置与布局**。包含 Reset CSS, Typography, 和全屏背景动画逻辑。 |
| `components.css` | **通用组件库**。定义按钮 (`.btn`), 输入框 (`.input`), 卡片 (`.card`) 等复用样式。 |

### 7.3 全局共享逻辑 (custom/shared/ & dynamic-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `admin-core.module.js` | **[CORE] 管理后台基石**。提供批量选择 (`BatchItemManager`)、全局保存条 (`SaveButton`)、操作按钮生成器 (`AdminButtonHelper`) 和统一反馈接口 (`Feedback`)。是所有 Admin 模块的公共依赖。|
| `module-config.module.js`| **配置中心**。定义了 CMS 的所有元数据（图标、允许的特性、数据文件路径）。是 CMS 实现多态 (Polymorphism) 的核心。|
| `ui/layout.module.js` | **布局初始化**。渲染公共 Header/Menu。 |
| `ui/theme.module.js` | **主题管理**。管理深色模式切换和缩放。 |

### 7.4 数据与管理 (data-manage/)
| 文件名 | 描述 |
| :--- | :--- |
| `api-client.module.js` | **API 客户端**。统一封装 `fetch` 请求，处理 GET/POST，可以看作是简化的 Axios。 |

### 7.5 全局配置 (custom/)
| 文件名 | 描述 |
| :--- | :--- |
| `config.js` | **环境配置**。定义全局常量（如 API 基础路径）。在 HTML 中优先加载，通过 `MAERS.Config` 全局访问。 |
