# MAERS 文件功能说明图谱

本文档提供了项目中所有关键文件的功能字典。如果您想修改某个功能但不知道改哪个文件，请查阅此表。

---

## 📋 目录 (Table of Contents)

1. [根目录文件 (Root)](#1-根目录文件-root)
2. [后端核心引擎 (_studio)](#2-后端核心引擎-_studio)
3. [CMS 模块 (custom/cms)](#3-cms-模块-customcms)
4. [相册模块 (custom/album)](#4-相册模块-customalbum)
5. [音乐模块 (custom/music)](#5-音乐模块-custommusic)
6. [文学模块 (custom/literature)](#6-文学模块-customliterature)
7. [首页模块 (custom/index)](#7-首页模块-customindex)
8. [移动端适配 (custom/zmobile adaptation)](#8-移动端适配-customzmobile-adaptation)
9. [关键基础设施 (Style, Data, Dynamic)](#9-关键基础设施)

---

## 1. 根目录文件 (Root)

| 文件名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `index.html` | Entry | **网站首页**。包含 3D 地球特效、身份卡片和导航入口。 |
| `notes.html` | Entry | **笔记列表页 (访客)**。读取 JSON 数据展示笔记树和 Markdown 内容。 |
| `photos.html` | Entry | **相册瀑布流页 (访客)**。展示摄影作品，支持分类筛选和灯箱查看。 |
| `music.html` | Entry | **音乐播放器页 (访客)**。全屏沉浸式播放器界面。 |
| `admin.html` | Entry | **后台管理首页**。管理员 Dashboard 入口。 |
| `admin-cms.html` | Entry | **笔记编辑器 (管理)**。包含完整的文件树操作、Vditor 编辑器和保存功能。 |
| `admin-album.html` | Entry | **相册/分类管理器**。画廊模块的管理后台，支持多层级分类和图片上传。 |
| `maers-version-controller.js` | Service Worker | **缓存与版本控制器**。拦截网络请求追加版本号。修改此文件中的 VERSION 可触发全站更新。 |
| `literature.html` | Entry | **文学长廊 (访客)**。Flow Engine 驱动的沉浸式书籍阅览室。 |


---

## 2. 后端核心引擎 (_studio)

路径：`_studio/` (Python 环境)

| 文件名 | 描述 |
| :--- | :--- |
| `server.py` | **服务器入口**。初始化原生 HTTP Server，配置静态资源路径，启动 HTTP 服务。 |
| `routes.py` | **路由控制器**。定义所有 `/api/*` 接口，接收前端请求并分发给 Service 层。 |
| `config.py` | **配置文件**。定义端口号、数据库路径、上传目录等全局常量。 |
| `clean-data.py` | **全量清理工具**。扫描 `cms.db` 和 `gallery.db`，清理所有未引用的图片文件及无效数据库记录。 |
| `wipe-data.py` | **数据销毁工具**。清空数据库和物理图片，将网站重置为“出厂状态”。 |
| `services/` | **业务逻辑层文件夹** |
| ├── `cms.py` | **CMS服务**。处理 Notes/Literature/Record 数据。支持节点增删改查及**拖拽重排 (Reorder)**。操作后自动生成 `*-tree.json`。 |
| ├── `album.py` | **分类服务**。管理相册的顶级分类、排序及元数据。操作后同步 `CATEGORY_CONFIG`。 |
| ├── `photos.py` | **相册服务**。处理图片上传与管理 (Pillow)。操作后自动生成 `photos-data.json`。 |
| ├── `music.py` | **音乐服务**。处理歌单增删改。操作后自动生成 `music-data.json`。 |
| └── `bili.py` | **B站服务**。获取B站视频信息的辅助工具。 |
| `启动管理后台(server.py).bat` | **一键启动**。启动后端 API 服务并自动在浏览器打开管理后台。 |
| `清理垃圾数据(clean-data.py).bat` | **维护工具**。一键执行数据清理，移除孤儿图片。 |
| `清空所有数据(wipe-data.py).bat` | **危险工具**。一键抹除全站用户数据。 |
| `快捷打开文件(open-file.py).bat` | **辅助工具**。快速打开当前正在编辑的物理文件。 |

---

## 3. CMS 模块 (custom/cms)

这是最复杂的模块，负责笔记的展示与管理。

### 3.1 访客端 (viewer/)
路径：`custom/cms/viewer/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-view.module.js` | **主视图控制器**。协调渲染、事件绑定和状态管理，是 CMS 访客端的入口。 |
| `cms-render.module.js`| **渲染引擎**。负责生成文件夹树、笔记列表、面包屑及**全量筛选视图遮罩 (Breadcrumb Overlay)**。 |
| `cms-events.module.js`| **事件监听器**。处理点击、搜索、快捷键，并实现**上下文智能导航 (Smart Context Navigation)**。 |
| `cms-state.module.js` | **状态管理**。维护当前路径、选中节点、展开状态等数据。 |
| `cms-search.module.js`| **搜索引擎**。实现前端纯文本搜索、标签过滤及**动态视图刷新联动**。 |
| `cms-tags.module.js` | **标签系统**。处理标签的提取、渲染、过滤及**自动分类展开**逻辑。 |
| `cms-recent.module.js`| **快速访问**。管理“最近访问”和“固定访问”的文件列表，支持模块隔离存储 (Notes/Lit/Record) 和图钉操作。 |
| `cms-lightbox.module.js`| **灯箱组件**。CMS 专用的Markdown图片查看器。 |
| `cms-base.css` | **基础样式**。Grid 布局、响应式框架，不包含色彩主题。 |
| `cms-theme-default.css`| **默认主题**。定义文件夹图标、颜色、圆角等视觉样式。 |

### 3.2 管理端 (admin/)
路径：`custom/cms/admin/`

| 文件名 | 描述 |
| :--- | :--- |
| `cms-controller.module.js`| **管理端主控**。扩展了访客端功能，封装 API 调用（含 `reorder` 排序接口）。 |
| `cms-admin.module.js` | **UI 交互控制器**。负责工具栏按钮事件、弹窗交互、批量操作（BatchManager）及**乐观 UI 删除 (Optimistic UI)**。 |
| `cms-editor.module.js` | **编辑器集成**。封装 `Vditor` 实例，处理 Markdown 的加载与保存。 |
| `cms-drag.module.js` | **拖拽排序**。使用 `SortableJS` 实现文件和文件夹的拖拽移动、排序。 |
| `admin-cms.css` | **管理样式**。增加工具栏、右键菜单、编辑器容器等特定样式。 |

---

## 4. 相册模块 (custom/album)

路径：`custom/photos/` (UI/逻辑) 与 `custom/album/` (分类/管理外壳)

*   **Viewer (访客端)**: 主力在 `custom/photos/viewer/`，由 `photos.html` 加载。
*   **Admin (管理端)**: 主力在 `custom/album/admin/`，由 `admin-album.html` 加载 (引用 `custom/album/admin-main.module.js`)。

| 文件名 | 目录 | 描述 |
| :--- | :--- | :--- |
| `photos-view.module.js` | `photos/viewer` | **瀑布流视图**。计算图片位置实现 Masonry 布局，处理懒加载。 |
| `photos-header-btn.css` | `photos/viewer` | **排序菜单样式**。适配 Dark Mode 的下拉菜单。 |
| `photos-viewer.css` | `photos/viewer` | **基础样式**。定义瀑布流容器、图片卡片及响应式布局。 |
| `photos-lightbox.module.js`| `photos/viewer` | **灯箱组件**。全屏查看图片，支持手势缩放和键盘切换。 |
| `admin-main.module.js` | `album` | **管理入口**。初始化相册管理 Dashboard。 |
| `photos-controller.module.js`| `photos/admin` | **图片逻辑**。处理图片上传、物理删除及 API 调用。 |
| `photos-upload.module.js` | `photos/admin` | **上传组件**。拖拽上传区域 UI。 |

---

## 5. 音乐模块 (custom/music)

路径：`custom/music/`

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。初始化播放器实例。 |
| `music-player-core.module.js`| `viewer/` | **核心引擎**。封装 `Audio` 对象，实现播放/暂停、音量控制及 `on/emit` 事件发布。 |
| `music-control.module.js` | `viewer/` | **逻辑控制器**。处理播放模式（随机/循环）、列表管理及上一曲/下一曲切换逻辑。 |
| `music-render.module.js` | `viewer/` | **渲染引擎**。负责生成播放列表 DOM、更新封面图及高亮当前歌曲。 |
| `music-ui.module.js` | `viewer/` | **UI 交互**。处理进度条拖动、封面旋转动画及界面事件绑定。 |
| `music-player-iframe.module.js`| `viewer/` | **扩展播放源**。支持 YouTube/Bilibili 等 Iframe 嵌入式播放。 |
| `music-player-pip.module.js`| `viewer/` | **画中画模式**。处理悬浮窗状态下的特殊 UI 逻辑。 |
| `music-state.module.js` | `viewer/` | **状态持久化**。监听核心事件，负责将播放进度和列表位置保存到 LocalStorage。 |
| `music.css` | `viewer/` | **模块样式**。定义播放器沉浸式界面及动画。 |

---

## 6. 文学模块 (custom/literature)

路径：`custom/literature/`

**核心特性**：Flow Engine (虚拟滚动流动引擎) + Polymorphic CMS (复用 CMS 内核)。

| 文件名 | 子目录 | 描述 |
| :--- | :--- | :--- |
| `main.module.js` | - | **入口文件**。注入 CMS 依赖，初始化 Flow Engine。 |
| `literature-view.module.js` | `viewer/` | **Flow Engine (核心)**。实现 3D 路径计算、虚拟滚动优化 (Virtual Scrolling) 及 WebP 封面渲染。 |
| `literature.css` | `viewer/` | **文学样式**。定义 3D 视口、书籍卡片样式及独特的交互动画。 |
| `literature-reset.css` | `viewer/` | **样式重置**。**[CRITICAL]** 强制覆盖 CMS 通用样式 (如 Clip-path, Transforms)，还原书籍的扁平化设计。 |

---

## 7. 首页模块 (custom/index)

| 路径 | 文件 | 描述 |
| :--- | :--- | :--- |
| `custom/index/` | `index-3d.module.js` | **3D 地球**。首页旋转地球的 Canvas 实现。 |
| `custom/index/admin/` | `admin-core.module.js` | **Admin Core**。虽然放在 index 下，实际上是**全站 Admin 的公共基类** (BatchManager, SaveButton 等)。 |

---

---

## 8. 移动端适配 (custom/zmobile adaptation)

路径：`custom/zmobile adaptation/`

**策略**: 物理隔离。主文件负责 Desktop 布局，此目录下的文件专门负责 Mobile/Tablet 端的样式覆盖。所有样式选择器均加 `body` 前缀以提升权重。

| 文件名 | 对应主文件 | 描述 |
| :--- | :--- | :--- |
| `mobile-global.css` | `style.css` | **全局适配**。处理容器内边距、禁用高性能消耗动画（毛玻璃/星空）以提升手机流畅度。 |
| `mobile-cms.css` | `cms-base.css` | **CMS 适配**。搜索框全宽、工具栏堆叠、网格列数自适应。 |
| `mobile-music.css` | `music.css` | **音乐适配**。播放列表与视频区域由“左右”改为“上下”堆叠。 |
| `mobile-index.css` | `index.css` | **首页适配**。预留文件，用于微调首页网格。 |
| `mobile-literature.css` | `literature.css` | **文学适配**。调整 3D 视口高度、书籍卡片大小、隐藏工具栏等。 |

---

## 9. 关键基础设施

这些文件支撑着整个网站的运行。

### 7.1 动态脚本 (dynamic-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `flash-guard.js` | **[CRITICAL] 防闪烁守卫**。同步加载的脚本，在渲染前注入遮罩和主题类，防止 FOUC。包含 LocalStorage 读取和 Favicon 注入。 |
| `theme-init.module.js`| **主题初始化**。ES6 模块，负责页面加载后的主题切换逻辑 (Toggle Button)。 |

### 7.2 全局样式 (static-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `theme.css` | **[CORE] 变量定义**。定义 `--bg-base`, `--text-main` 等 CSS 变量，是深色模式的核心。 |
| `style.css` | **全局重置与布局**。包含 Reset CSS, Typography, 和全屏背景动画逻辑。 |
| `components.css` | **通用组件库**。定义按钮 (`.btn`), 输入框 (`.input`), 卡片 (`.card`) 等复用样式。 |

### 7.3 全局共享逻辑 (custom/shared/ & dynamic-style/)
| 文件名 | 描述 |
| :--- | :--- |
| `admin-core.module.js` | **[CORE] 管理后台基石**。提供批量选择 (`BatchItemManager`)、全局保存条 (`SaveButton`)、操作按钮生成器 (`AdminButtonHelper`) 和统一反馈接口 (`Feedback`)。是所有 Admin 模块的公共依赖。|
| `module-config.module.js`| **配置中心**。定义了 CMS 的所有元数据（图标、允许的特性、数据文件路径）。是 CMS 实现多态 (Polymorphism) 的核心。|
| `ui/layout.module.js` | **布局初始化**。渲染公共 Header/Menu。 |
| `ui/theme.module.js` | **主题管理**。管理深色模式切换和缩放。 |

### 7.4 数据与管理 (data-manage/)
| 文件名 | 描述 |
| :--- | :--- |
| `api-client.module.js` | **API 客户端**。统一封装 `fetch` 请求，处理 GET/POST，可以看作是简化的 Axios。 |

### 7.5 全局配置 (custom/)
| 文件名 | 描述 |
| :--- | :--- |
| `config.js` | **环境配置**。定义全局常量（如 API 基础路径）。在 HTML 中优先加载，通过 `MAERS.Config` 全局访问。 |
